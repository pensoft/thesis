<?php
$x = session_start(); //na servera session_autostart e 0
//~ var_dump($x);
include_once(getenv("DOCUMENT_ROOT") . "/lib/conf.php");
require_once(PATH_ECMSFRCLASSES . 'static.php');
include_once(getenv("DOCUMENT_ROOT") . "/lib/struct.php");
include_once(getenv("DOCUMENT_ROOT") . "/lib/cuser.php");

$gSiteStruct = GetSitesStruct();
$gSiteAccess = GetAccess();
$gTimeLogger = new ctime_logger(array());
$gEcmsLibRequest = 
	(
		(
			($_SERVER["HTTP_USER_AGENT"] =="ecmsconnect") 
			|| ($_SERVER["HTTP_USER_AGENT"] =="wsb") 
		)
		|| (int) $_REQUEST['force_json_output']
	) 
	? 1 : 0;

	//~ $gEcmsLibRequest = 1;
if((int) $gEcmsLibRequest ){
	//~ error_reporting(0);//Spirame vsi4ki greshki
	//~ define('ERROR_REPORTING', 0);//Za da moje ako nqkyde sled statica se vika error_reporting da ne se precakame
	ini_set('display_errors', 'Off');
}
$gUrl = substr(getenv('SCRIPT_NAME'), 0, strrpos(getenv('SCRIPT_NAME'), '/') + 1);
$gSiteAccessType = $gSiteAccess[$gUrl];
if (!$gSiteAccessType) $gSiteAccessType = 0;

$gBHLData = ''; //tazi promenliva se polzva pri chetene na xml-a ot BHL v callback funkciata

$gStoriesStates = array (
	0 => 'Пишеща се',
	1 => 'За коректор',
	2 => 'За редактор',
	3 => 'Публикувана',
	//~ 4 => 'Публикувана (За корекция и преглед)',
);

$gImageExtensions = array (
	1=> '.gif',
	2=> '.png',
);

$gFightDscids = array();

function HtmlStart($Hide = 0) {
	global $user, $gUrl,$gEcmsLibRequest;
	
	ProccessHistory();
	if( !$gEcmsLibRequest ){
		echo '
		<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
		<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="' . getlang(true) . '" lang="' . getlang(true) . '">
		<head>
			<meta http-equiv="content-type" content="text/html; charset=utf-8" />
			<title>Etaligent CMS Administration</title>
			<meta name="description" content="Etaligent CMS Administration" />
			<meta name="keywords" content="Etaligent CMS Administration" />
			<meta name="author" content="Etaligent.net"/>
			<meta name="robots" content="index,follow" />
			<meta name="language" content="' . getlang(true) . '" />
			<meta name="generator" content="Etaligent.Net CMS" />
			<link rel="SHORTCUT ICON" href="/favicon.ico" type="image/x-icon"/>
			<link rel="ICON" href="/favicon.ico" type="image/x-icon"/>
			<link type="text/css" rel="stylesheet" href="/resources/icotest/HtmlText/HtmlText.css" media="all" title="default" />
			<link type="text/css" rel="stylesheet" href="/lib/def.css" media="all" title="default" />
			<link type="text/css" rel="stylesheet" href="/lib/orange.css" media="all" title="orange" />
			<link type="text/css" rel="stylesheet" href="/lib/green.css" media="all" title="green" />
			<link type="text/css" rel="stylesheet" href="/lib/black.css" media="all" title="black" />
			<link type="text/css" rel="stylesheet" href="/lib/def.css" media="all" title="blue" />			
			<script type="text/javascript" language="JavaScript">
				var gSiteUrl = \'' . ADM_URL .  '\';
			</script>
			<script type="text/javascript" language="JavaScript" src="/lib/ajaxObjectsDescriptor.js"></script>			
			<script type="text/javascript" language="JavaScript" src="/lib/def.js"></script>			
			<script type="text/javascript" language="JavaScript" src="/lib/EWorkaround.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/EDispecher.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/markuptool.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/TextHolder.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/Selection.js"></script>
			
			
			<script type="text/javascript" language="JavaScript" src="/lib/HtmlText/Screen.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/HtmlText/common.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/HtmlText/HtmlText.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/HtmlText/HtmlTextInitializer.js"></script>
		</head>
		<body>
		<div id="wrapper">
		';
		if (!$Hide) {
			echo '
			<div id="header">
				<a href="/" id="logo"></a>
				' . ($user ? '
					' . getstr('admin.hello') . ' ' . $user->fullname . '
					[ <a href="/profile/passwd/">' . getstr('admin.changePass') . '</a> | 
					<a href="/login/index.php?l=1">' . getstr('admin.logOut') . '</a> ]
				' : '
					' . getstr('admin.pleaseLogin') . '
				') . '
			</div>
			' . DisplayMenu('/') . '
			<script language="JavaScript">ActivateMenu(\'menu\');</script>
			
			<div class="unfloat"></div>
			<div id="main"' . ($Hide ? ' class="noMarginMain"' : '') . '>
			';
		}
	}	
	UserRedir($user);	}

function HtmlStartXml($Hide = 0) {
	global $user, $gUrl, $gEcmsLibRequest;
	
	ProccessHistory();
	
	if( !$gEcmsLibRequest ){
		echo '
		<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
		<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="' . getlang(true) . '" lang="' . getlang(true) . '">
		<head>
			<meta http-equiv="content-type" content="text/html; charset=utf-8" />
			<title>Etaligent CMS Administration</title>
			<meta name="description" content="Etaligent CMS Administration" />
			<meta name="keywords" content="Etaligent CMS Administration" />
			<meta name="author" content="Etaligent.net"/>
			<meta name="robots" content="index,follow" />
			<meta name="language" content="' . getlang(true) . '" />
			<meta name="generator" content="Etaligent.Net CMS" />
			<link rel="SHORTCUT ICON" href="/favicon.ico" type="image/x-icon"/>
			<link rel="ICON" href="/favicon.ico" type="image/x-icon"/>
			<link type="text/css" rel="stylesheet" href="/lib/def.css" media="all" title="default" />
			<link type="text/css" rel="stylesheet" href="/lib/orange.css" media="all" title="orange" />
			<link type="text/css" rel="stylesheet" href="/lib/green.css" media="all" title="green" />
			<link type="text/css" rel="stylesheet" href="/lib/black.css" media="all" title="black" />
			<link type="text/css" rel="stylesheet" href="/lib/def.css" media="all" title="blue" />
			
			<script type="text/javascript" language="JavaScript">
				var gSiteUrl = \'' . ADM_URL .  '\';
			</script>
			<script type="text/javascript" language="JavaScript" src="/lib/ajaxObjectsDescriptor.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/def.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/EWorkaround.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/EDispecher.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/markuptool.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/TextHolder.js"></script>
			<script type="text/javascript" language="JavaScript" src="/lib/Selection.js"></script>
			
		</head>
		<body>
		';

		if (!$Hide) {
		echo '
			<div id="header">
				<a href="/" id="logo"></a>
				' . ($user ? '
					' . getstr('admin.hello') . ' ' . $user->fullname . '
					[ <a href="/profile/passwd/">' . getstr('admin.changePass') . '</a> | 
					<a href="/login/index.php?l=1">' . getstr('admin.logOut') . '</a> ]
				' : '
					' . getstr('admin.pleaseLogin') . '
				') . '
			</div>
			' . DisplayMenu('/') . '
			<script language="JavaScript">ActivateMenu(\'menu\');</script>
			';
		}
	}
	
	UserRedir($user);	
}

function HtmlEnd($Hide = 0) {
	global $gEcmsLibRequest;
	if( !$gEcmsLibRequest ){		
		UpdateHistory();
		
		
		if (!$Hide) {
			echo '
				<br/>
			</div>
			<div class="unfloat"></div>
			<div id="footer">
				' . getstr('admin.copywright') . '
			</div>
			</div>
		' . returncalendarlayers() . '
		</body>
		</html>';
		}
	}else{
		DisplayJSONOrganizer();
	}
}

function HtmlEndXml($Hide = 0) {
	global $gEcmsLibRequest;
	if( !$gEcmsLibRequest ){
		UpdateHistory();
			
		
		if (!$Hide) {
			echo '
			<div id="footer">
				' . getstr('admin.copywright') . '
			</div>';
		}
		
		echo '	
		</body>
		</html>';
	}else{
		DisplayJSONOrganizer();
	}
}

function nullstr($pParam) {
	if ($pParam) {
		return '\'' . q($pParam) . '\'';
	} else {
		return 'NULL';
	}
}

function IsInt($pVal) {
	if (is_numeric($pVal))
		if (doubleval($pVal) - intval($pVal) == 0)
			return 1;
	return 0;
}

function ErrOut($pStr) {
	echo '<p style="color: Red; font-size: 12pt;"><b>ERROR: </b> ' . $pStr;
}

function UserRedir($pUser) {
	global $gUrl, $gSiteAccess, $gEcmsLibRequest;
	if (!$gSiteAccess[$gUrl]) {
		if (!$pUser) {
			$url = getenv("REQUEST_URI");
			if (!$gEcmsLibRequest) header('Location: /login/index.php?url=' . urlencode($url));
			else echo json_encode(array("err"=> -778, "rescnt" => 0, "errdesc"=> "You must login first!"));
			exit;
		} else {
			if (!$gEcmsLibRequest) header('Location: /error.php');
			else echo json_encode(array("err"=> -779, "rescnt" => 0, "errdesc"=> "You don't have permission to access this data!"));
			exit;
		}
	}
}

function CountOnBits($int){
	$r=0;
	while($int>0){
		if($int % 2) $r++;
		$int>>=1;
	}
	return $r;
}

function ckdt1($pStr, $pCheck = 1) {
	if (!preg_match('/[\/\\\.\-]/', $pStr, $lMatches)) {
		return false;
	}
	
	$lSeparator = $lMatches[0]; //Kato nqma skobi v reg expa v 0-q element e kakvoto e machnalo
	
	if (!preg_match('/^(\d{1,2})\\' . $lSeparator .  '(\d{1,2})\\' . $lSeparator . '(\d{2,4})$/i', $pStr, $lMatches)) {
		return false;
	}
	
	if (!checkdate($lMatches[2], $lMatches[1], $lMatches[3])) {
		return false;
	}
	
	if (!$pCheck) {return $lMatches;}
	else {return true;}
}

function getSiteName($pRs) {
	global $gSiteArr;
	return $gSiteArr['name'][$pRs['primarysite']];
}
function getSiteDir($pRs) {
	global $gSiteArr;
	return $gSiteArr['dir'][$pRs['primarysite']];
}

function getsubnav($navarr, $p) {
	global $gSiteTabsHide;
	
	$r = '<table class="tabtable"><tr>';
	foreach ($navarr as $k => $v) {
		if (!is_array($gSiteTabsHide) || !in_array($k, $gSiteTabsHide)) {
			$r .= '<td><div' . ($k == $p ? ' class="seltab"' : '') . '><a href="' . $v[0] . '">' . $v[1] . '</a></div></td>';
		}	
	}
	$r .= '</tr></table>';
	return $r;
}

function showRelatedItems($guid, $sid = 0) {
	echo '
	<div id="framesholder">
		<iframe class="rels" border="0" id="relsframe" name="relsframe" src="/resources/stories/relstories.php?guid='.$guid.'&sid='.$sid.'"></iframe>	
		<iframe class="rels" border="0" id="linkframe" name="linkframe" src="/resources/stories/relinks.php?guid='.$guid.'"></iframe>	
		<iframe class="rels" border="0" id="picsframe" name="picsframe" src="/resources/stories/relpics.php?guid='.$guid.'&sid='.$sid.'"></iframe>
		<iframe class="rels" border="0" id="attframe" name="attframe" src="/resources/stories/relattachments.php?guid='.$guid.'&sid='.$sid.'"></iframe>
		<iframe class="rels" border="0" id="medframe" name="medframe" src="/resources/stories/relmedia.php?guid='.$guid.'"></iframe>
	</div>
	';
}

function showRelatedAttributes($pNodeId) {
	echo '
	<div id="framesholder">
		<iframe class="rels" border="0" id="relsframe" name="relsframe" src="/resources/xml_nodes/relattributes.php?node_id='. (int)$pNodeId .'"></iframe>			
	</div>
	';
}

function showRelatedProperties($pRuleId) {
	global $gEcmsLibRequest;
	if( !$gEcmsLibRequest ) {
		echo '
		<div id="framesholder" class="rule_properties">
			<iframe class="rels" border="0" id="relsframe" name="relsframe" src="/resources/autotag_rules/relproperties.php?rule_id='. (int)$pRuleId .'"></iframe>			
		</div>
		';
	}
}

function showRelatedSyncDetails($pTemplateId) {
	global $gEcmsLibRequest;
	if( !$gEcmsLibRequest ) {
	echo '
	<div id="framesholder" class="rule_properties">
		<iframe class="rels" border="0" id="relsframe" name="relsframe" src="/resources/xml_sync_templates/reldetails.php?template_id='. (int)$pTemplateId .'"></iframe>			
	</div>
	';
	}
}

function showIndesignTemplateDetails($pTemplateId) {	
	global $gEcmsLibRequest;
	if( !$gEcmsLibRequest ) {
	echo '
	<div id="framesholder" class="rule_properties">
		<iframe class="rels" border="0" id="relsframe" name="relsframe" src="/resources/indesign_templates/reldetails.php?template_id='. (int)$pTemplateId .'"></iframe>			
	</div>
	';
	}
}

function showSyncedXmlDetails($pArticleId) {	
	global $gEcmsLibRequest;
	if( !$gEcmsLibRequest ) {
	echo '
	<div id="framesholder" class="rule_properties">
		<iframe class="rels" border="0" id="relsframe" name="relsframe" src="/resources/articles/reldetails.php?article_id='. (int)$pArticleId .'"></iframe>			
	</div>
	';
	}
}

function showRelatedVariables($pSourceId) {	
	global $gEcmsLibRequest;
	if( !$gEcmsLibRequest ) {
	echo '
	<div id="framesholder" class="rule_properties">
		<iframe class="rels" border="0" id="relsframe" name="relsframe" src="/resources/autotag_rules/autotag_re_sources/relvariables.php?source_id='. (int)$pSourceId .'"></iframe>			
	</div>
	';
	}
}

function checkplace($pRs) {
	$lArr = array (
		0 => "Не се показва в статията",
		1 => "Горе Дясно",
		2 => "Горе Ляво",
		3 => "Долу",
		4 => "Голяма снимка",
	);
	if ($pRs['frst'])
		return $lArr[$pRs['place']] . ' (<span style="color:red">При заглавието</span>)';
	 else 
		return $lArr[$pRs['place']];
}

function retcalico($pfield, $pform='def1') {
	return returncalendarico($pfield, $pform);
}
function returncalendarico($pfield, $pform='def1') {
	return '<a href="#" onclick="jscalshow(this, \'' . $pform . '\', \'' . $pfield . '\'); return false;"><img src="/img/calico.gif" border="0"/></a>';
}
function returncalendarlayers() {
	return '<div id="calid" style="z-index: 2; display: none; position: absolute; width: 150px; height: auto; background-color: White;"></div>
		<iframe id="calidfrm" style="z-index: 1; display: none; position: absolute; left: 0px; top: 0px;" src="javascript:false;" frameborder="0" scrolling="no"></iframe>';
}

function isAdmin() {
	global $user;
	if (in_array('Admin', $user->grpnames)) return 1;
	return 0;
}

function GetSiteRights() {
	global $user;
	static $lSiteRights;
	
	if (!is_array($lSiteRights) || count($lSiteRights) == 0) {
		foreach ($user->arrPerm as $url => $actipe) {
			if (preg_match('/\*sid(\d+)/', $url, $mm)) {
				if ($actipe > 1) {
					$lSiteRights[$mm[1]] = 'edit';
				} else {
					$lSiteRights[$mm[1]] = 'view';
				}
			}
		}
	}
	
	return $lSiteRights;
}

function SqlProvIn($fld = "provider_id") {
	$lProvRights = ProviderRights();
	if (!isAdmin()) {
		if (!is_array($lProvRights)) $lProvRights = array();
		foreach ($lProvRights as $k => $v) $instr[] = $k;
		
		if (count($instr) > 0) {
			$instr = implode(', ', $instr);
			return $fld . ' IN (' . $instr . ')';
		}
	}
	return ' true ';
}

// FUNKCII ZA escape na adresi (preobrazuvane url-ta i email adresi v linkove); preobrazuvane na specialnite kavichki v normalni
function parseUrls($txt) {
	$parsed = '';
	$lines = preg_split('/<br \/>/', $txt);
	foreach ($lines as $line) {
		$parsedLine = '';
		if ($line) {
			$words = preg_split('/[\ ]/', $line);
			foreach ($words as $word) {
				$w = parseWordUrls($word);
				$parsedLine .= $w.' ';
			}
		}
		$parsed .= trim($parsedLine) . '<br />';
	}
	return $parsed;
}

function parseWordUrls($str) {
	$delim = '[\(\)\[\]\{\}\<\>\"\'\/\\\\.,;?!]*';
	$left_delim = $delim; 	// = '[\(\[\{\<\"\']*';
	$right_delim = $delim; 	// = '[\)\]\}\>\"\']*';
	$url_pattern = '/^'.$left_delim.'((http|https|ftp|gopher|news):\/\/|www\.)/';
	$email_pattern = '/^'.$left_delim.'[A-Za-z0-9._-]+@[A-Za-z0-9.-]+\.(?:[A-Za-z]{2}|com|org|net|biz|info|name|aero|jobs|museum)'.$right_delim.'$/';
	
	if (preg_match($url_pattern, $str)) {
		$address = preg_replace('/^'.$left_delim.'(http:\/\/)?(www\.)?(.+?)'.$right_delim.'$/', 'http://${2}${3}', $str);
		$addr_orig = preg_replace('/^'.$left_delim.'(.+?)'.$right_delim.'$/', '${1}${2}', $str);
		$link = '<a href="' . trim($address) . '" target="_blank" >'. $addr_orig .'</a>';
		$res = preg_replace('/^('.$left_delim.')(.+?)('.$right_delim.')$/', '${1}'. $link .'${3}', $str);

	} elseif (preg_match($email_pattern, $str)) {
		$address  = preg_replace('/^'.$left_delim.'(.+?)'.$right_delim.'$/', '${1}', $str);
		$link = '<a href="mailto:' . trim($address) .'">'. $address .'</a>';
		$res = preg_replace('/^('.$left_delim.')(.+?)('.$right_delim.')$/', '${1}'.$link.'${3}', $str);		
	} else {
		$res = $str;		
	}
	return $res;
}

function parseSpecialQuotes($str) {
	return str_replace(array('&bdquo;', '„', '“', '”', '&laquo;', '&raquo;', '&ldquo;', '&rdquo;'), array('"', '"', '"', '"', '"', '"', '"', '"'), $str);
}

function getStoryChangeLog($pGuid) {
	if (!$pGuid) {
		return array();
	}
	$sql = 'SELECT s.modtime, s.status, usr.uname, s.init
				FROM storychangelog s JOIN usr ON (usr.id = s.userid) 
				WHERE guid = '. $pGuid .'
				ORDER BY s.modtime';
	$cn = Con();
	$cn->Execute($sql);
	$cn->MoveFirst();
	$res = array();
	while (!$cn->Eof()) {
		$modtime = preg_replace('/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})\.\d+/', 
							 '$3-$2-$1 / $4:$5', $cn->mRs['modtime']);
		$uname = $cn->mRs['uname'];
		$status = $cn->mRs['status'];
		$init = $cn->mRs['init'];
		$cn->MoveNext();
		$res[] = array(
			'modtime' => $modtime, 
			'uname' => $uname, 
			'status' => $status,
			'init' => $init
		);
	}
	return $res;
}

function matchTextUrls($text) {
	$str = preg_replace('/\r*\n/', " \n ", $text);
	$words = preg_split('/[\ ]+/', $str);
	foreach ($words as $word) {
		$w = matchWordUrls($word);
		$replaced .= $w.' ';
	}
	return nl2br($replaced);
}

function matchWordUrls($str) {
	$delim = '[\(\)\[\]\{\}\<\>\"\'\/\\\\.,;!?]*';
	$left_delim = $delim; 	// = '[\(\[\{\<\"\']*';
	$right_delim = $delim; 	// = '[\)\]\}\>\"\']*';
	$url_pattern = '/^'.$left_delim.'((http|https|ftp|gopher|news):\/\/|www\.)/i';
	$email_pattern = '/^'.$left_delim.'[A-Za-z0-9._-]+@[A-Za-z0-9.-]+\.(?:[A-Za-z]{2}|com|org|net|biz|info|name|aero|jobs|museum)'.$right_delim.'$/i';
	
	if (preg_match($url_pattern, $str)) {
		$address = preg_replace('/^'.$left_delim.'(http:\/\/)?(www\.)?(.+?)'.$right_delim.'$/i', 'http://${2}${3}', $str);
		$addr_orig = preg_replace('/^'.$left_delim.'(.+?)'.$right_delim.'$/i', '${1}${2}', $str);
		$link = '<a href="' . h(trim($address)) . '" target="_blank" >'. $addr_orig .'</a>';
		$res = preg_replace('/^('.$left_delim.')(.+?)('.$right_delim.')$/i', '${1}'. $link .'${3}', $str);		

	} elseif (preg_match($email_pattern, $str)) {
		$address  = preg_replace('/^'.$left_delim.'(.+?)'.$right_delim.'$/i', '${1}', $str);
		$link = '<a href="mailto:' . h(trim($address)) .'">'. $address .'</a>';
		$res = preg_replace('/^('.$left_delim.')(.+?)('.$right_delim.')$/i', '${1}'.$link.'${3}', $str);			
	
	} else {
		$res = $str;
	}
	return $res;
}

function convertKwds($pKwds) {
	if ($pKwds) {
		$KWArr = explode(',', $pKwds);
		$kwds1 = array();
		$kwds2 = array();
		foreach ($KWArr as $kwd) {
			$kwd = trim(UnicodeToWin($kwd));
			$kwdFirstCh = substr($kwd, 0, 1);
			if ((ord($kwdFirstCh) >= 65 && ord($kwdFirstCh) <= 90) || (ord($kwdFirstCh) >= 176 && ord($kwdFirstCh) <= 223)) {
				$kwds2[] = $kwd;
			} else {
				$kwds1[] = $kwd;
			}
		}
		$resKwdsStr = WinToUnicode(implode(', ', array_merge($kwds1, $kwds2)));
	}
	return $resKwdsStr;
}

function StoryUsage($pGuid) {
	global $user;
	
	$con = Con();
	$con->Execute('SELECT * 
		FROM spStoryUsage(' . (int)$pGuid . ', ' . (int)$user->id . ', \'' . q($user->uname) . '\') 
		WHERE uid <> ' . (int)$user->id
	);
	
	$con->MoveFirst();
	
	if (!$con->RecordCount()) return;
	$ret = '<span>В последните 10 мин тази статия е била отваряна от:</span> ';
	$i = 1;
	while (!$con->Eof()) {
		$ret .= ' ' . $con->mRs['uname'];
		$ret .= ($i != $con->RecordCount() ? ',' : '');
		$i ++;
		$con->MoveNext();
	}
	return '<div id="underconstruction">' . $ret . '</div>';
}

function br2nl($str) {
	return preg_replace('/\<br[\s\/]*\>/', "\n", $str);
}

function GetState($state) {
	if ((int)$state) return 'Активен';
	return 'Неактивнен';
}

function jsGetState($state) {
	return escapeForJS(GetState($state));
}

function escapeForJS($str) {
	if (!$str) return '&nbsp;';
	return nl2br(addslashes(htmlspecialchars($str)));
}

function TrueOrFalse($bool) {
	if ($bool == 'false') return 'НЕ';
	return 'ДА';
}

function jsTrueOrFalse($bool) {
	return escapeForJS(TrueOrFalse($bool));
}

function GetUserType($utype) {
	if ((int)$utype == 1) return 'Power user';
	return 'Обикновен';
}

function jsGetUserType($utype) {
	return escapeForJS(GetUserType($utype));
}

function GetPriceType($pType) {
	if ((int)$pType == 1) return 'Процент';
	return 'Цена';
}

function FormatPgArray($arr) {
	$arr = preg_replace('/{(.+)}/', "\\1", $arr);
	$arr = array_map('trim', explode(',', $arr));
	return implode('<br/>', $arr);
}

function jsFormatPgArray($arr) {
	$arr = preg_replace('/{(.+)}/', "\\1", $arr);
	$arr = array_map('trim', explode(',', $arr));
	$arr = array_map('escapeForJS', $arr);
	return implode('<br/>', $arr);
}

function getMMThumb($pRs) {
	$gFilesRoot = PATH_DL;
	if ((int)$pRs['guid'] && is_file($gFilesRoot . 'o_' . $pRs['guid'] . '.jpg')) 
		return '<br/><a href="./multimedia.php?guid=' . $pRs['guid'] . '&tAction=edit"><img src="/showimg.php?f=m80_' . $pRs['guid'] . '.jpg" alt="" /></a>';
	return '';
}

function mmFtype($pRs) {
	if ($pRs['ftype'] == 3) return 'audio';
	if ($pRs['ftype'] == 4) return 'video';
	return '';
}

function mmModDate($pRs) {
	if (!preg_match('/(\d+)\/(\d+)\/(\d+) (\d+):(\d+)/', $pRs['lastmod'], $a)) {
		return $pRs['lastmod'];
	}
	$tstamp = mktime($a[4], $a[5], $a[6], $a[2], $a[1], $a[3]);
	return date('d/m/Y H:i', $tstamp);
}

function GetStoryStaus($state) {
	global $gStoriesStates;
	return $gStoriesStates[$state];
}

function clearcacheditems2($pType, $pSiteId = null) {
	if (!$pSiteId) {
		$a = glob(PATH_CACHE . '/*');
		foreach($a as $f) {
			$dir = PATH_CACHE . basename($f);
			touchDirFiles($dir, $pType);
		}
	} else {
		$dir = PATH_CACHE . '/' . $pSiteId . '/';
		touchDirFiles($dir, $pType);
	}
}


function touchDirFiles($pDir, $pType) {
	if (is_dir($pDir)) {
		if ($dh = opendir($pDir)) {
			while (($file = readdir($dh)) !== false) {
				if (strpos($file, $pType.'_') == 0) {
					touch($pDir . $file, strtotime('1/1/2000'));
				}
			}
			closedir($dh);
		}
	}
	if (is_file($pDir)) {
		if (strpos(basename($pDir), $pType.'_') == 0) {
			touch($pDir, strtotime('1/1/2000'));
		}
	}
}


function showRelatedPhotos($guid, $sid = 0) {
	echo '
	<div id="framesholder">
		<iframe class="rels" border="0" id="picsframe" style="height:500px;" name="picsframe" src="/resources/gallery/relpics.php?guid='.$guid.'&sid='.$sid.'"></iframe>
	</div>
	';
}

// s tazi funkciq se mahat bom markerite (utf-8 cookie-tata) ot string
function replaceBom($pStr) {
	return str_replace(chr(239) || chr(187) || chr(191), '', $pStr);
}

function removeUplFiles($pId, $pFilesRoot) {
	$lFiles = glob($pFilesRoot . '*_' . $pId . '.*');
	foreach ($lFiles as $lFile) {
		if (is_file($lFile))
			unlink($lFile);
	}
}

function removeVideoThumbs($pId, $pFilesRoot) {
	$lFiles = glob($pFilesRoot . '*_' . $pId . '.jpg');
	foreach ($lFiles as $lFile) {
		if (is_file($lFile))
			unlink($lFile);
	}
}

function delStoryFile($pStoryId) {
	if ((int)$pStoryId) {
		$lStoryFile = PATH_STORIES . (int)$pStoryId . '.html';
		if (is_file($lStoryFile))
			return unlink($lStoryFile);
	}
	return false;
}

function delStoryRecord($pCn, $pStoryId) {
	if ((int)$pStoryId && is_object($pCn) && $pCn instanceof DBCn) {
		$pCn->Execute('SELECT * FROM deleteVideo(' . (int)$pStoryId . ')');
	}
}

function delVideoFilesByStory($pStoryId) {
	$lCn = Con();
	$lCn->Execute('SELECT valint AS videoid FROM storyproperties WHERE propid = 13 AND guid = ' . (int)$pStoryId);
	$lCn->MoveFirst();
	$lVideoId = (int)$lCn->mRs['videoid'];
	if ($lVideoId) {
		removeUplFiles($lVideoId ,PATH_DL);
	}
}

function showPlayerByType($pFtype, $pId, $pHtml = false) {
	$lFtype = (int)$pFtype;
	$lId = (int)$pId;
	
	if ($lFtype && $lId) {
		switch ($lFtype) {
			case 3: // Audio
				return '
					<object style="vertical-align: middle;" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0" width="150" height="20">
						<param name="movie" value="/singlemp3player.swf?file=' . ADM_URL . GETATT_URL . 'o_' . $lId . '.mp3&songVolume=80&showDownload=false" />
						<param name="quality" value="high">
						<param name="wmode" value="transparent" />
						<embed
							style="vertical-align: middle;"
							width="150"
							height="20"
							src="/singlemp3player.swf?file=' . ADM_URL . GETATT_URL . 'o_' . $lId . '.mp3&songVolume=80&showDownload=false"
							quality="high"
							wmode="transparent"
							type="application/x-shockwave-flash"
							pluginspage="http://www.macromedia.com/go/getflashplayer"
						/>
					</object>
				';
				break;
			case 4: // Video
				return '
					<embed
						width="360"
						height="270"
						src="' . SITE_URL . '/mediaplayer.swf"
						quality="high"
						wmode="transparent"
						flashvars="width=360&amp;height=270&amp;autostart=false&amp;file=' . ADM_URL . GETATT_URL . 'oo_' . $lId . '.flv&amp;type=flv&amp;repeat=false&amp;image=' . ADM_URL . SHOWIMG_URL . 'big_' . $lId . '.jpg&amp;showdownload=false&amp;link=' . ADM_URL . GETATT_URL . 'oo_' . $lId . '.flv&amp;allowfullscreen=true&amp;showdigits=true&amp;shownavigation=true&amp;logo=&amp;largecontrols=false&amp;backcolor=0xffffff&amp;frontcolor=0x000000&amp;lightcolor=0x000000&amp;screencolor=0x000000"
						menu="false"
						allowfullscreen="true"
						loop="false"
						play="false"
						type="application/x-shockwave-flash"
						pluginspage="http://www.macromedia.com/go/getflashplayer"
					/>
				';
				break;
			case 5: // Embed video
				return $pHtml;
				break;
			default:
				break;
		
		}
	}
}

function showProductRelatedItems($guid, $sid = 0) {
	echo '
		<div id="framesholder">
			<iframe class="rels" width="100%" height="250px" border="0" id="picsframe" name="picsframe" src="/store/products/relpics.php?guid='.$guid.'&sid='.$sid.'"></iframe>
			<iframe class="rels" width="100%" height="120px" border="0" id="medframe" name="medframe" src="/store/products/relproducts.php?id='.$guid.'"></iframe>
		</div>
	';
}

function positive ($pArg){
	if($pArg > 0) return 1;
	return 0;
}

function checkplace2($pRs) {
	$lArr = array (
		3 => "Галерия",
	);
	if ($pRs['frst'])
		return $lArr[$pRs['place']] . ' (<span style="color:red">При заглавието</span>)';
	 else 
		return $lArr[$pRs['place']];
}

function getJSONOrganizer() {
	global $gJSONOrganizer;
	if (get_class($gJSONOrganizer) != 'JSONOrganizer') {
		$gJSONOrganizer = new JSONOrganizer();		
	}
	return $gJSONOrganizer;
}

function DisplayJSONOrganizer(){
	$lJSONOrganizer = getJSONOrganizer();
	$lJSONOrganizer->Display();
}

function SyncXmlData($pArticleId, $pXml){
	if(!(int) $pArticleId )
		return;
		
	$lDOM = new DOMDocument("1.0");
	$lDOM->resolveExternals = true;
	if( !$lDOM->loadXML($pXml))
		return;
	
	$lXPath = new DOMXPath($lDOM);
	
	$lCon = new DBCn();
	$lCon->Open();
	$lSql = '
		SELECT sd.id, sd.xpath, sd.sync_type, sd.sync_column_name, sd.sync_column_default_value 
		FROM xml_sync_details sd
		JOIN articles a ON a.xml_sync_template_id = sd.xml_sync_templates_id
		WHERE a.id = ' . (int) $pArticleId;
	$lCon->Execute($lSql);
	$lCon->MoveFirst();
	$lSql = 'DELETE FROM xml_sync WHERE article_id = ' . (int) $pArticleId . ';';//Triem starite zapisi
	//~ $lSql = '';
	while(!$lCon->Eof()){
		$lXpathExp = $lCon->mRs['xpath'];
		$lSyncType = (int)$lCon->mRs['sync_type'];
		$lSyncDetailId = (int)$lCon->mRs['id'];
		$lSyncColumnName = $lCon->mRs['sync_column_name'];
		$lDefaultValue = $lCon->mRs['sync_column_default_value'];
		
		$lXPathResult = $lXPath->query($lXpathExp);
		for($i = 0; $i < $lXPathResult->length; ++$i){
			$lNode = $lXPathResult->item($i);
			$lContent = trim($lNode->textContent);
			if( $lSyncType == (int) XML_SYNC_COLUMN_TYPE ){//Updatevame tekstova kolona ot articles i breakvame - taq kolona moje da ima samo 1 stoinost
				if( !$lContent ){
					$lContent = $lDefaultValue;
				}
				$lSql .= 'UPDATE articles SET ' . $lSyncColumnName . ' = \'' . q($lContent) . '\' WHERE id = ' . (int) $pArticleId . ';';
				break;
			}else{//Slagame zapis v xml_sync
				$lSql .= 'INSERT INTO xml_sync (xml_sync_details_id, article_id, data) VALUES (' . (int) $lSyncDetailId . ', ' . (int) $pArticleId . ', \'' . q($lContent) . '\');';
			}			
		}
		if( $lSyncType == (int) XML_SYNC_COLUMN_TYPE && !$lXPathResult->length){//Slagame default stoinosta
			$lSql .= 'UPDATE articles SET ' . $lSyncColumnName . ' = \'' . q($lDefaultValue) . '\' WHERE id = ' . (int) $pArticleId . ';';
		}
		$lCon->MoveNext();
	}
	$lCon->Close();
	$lCon->Open();
	$lCon->Execute($lSql);	
}

function executeExternalQuery($pURL, $pPostFields = false, $pCBF = '', $pTimeout = 0){
	$lCurlHandler = curl_init($pURL);
	$lUserAgent = "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.1) Gecko/20061204 Firefox/3.5.0.1"; 
	curl_setopt($lCurlHandler, CURLOPT_USERAGENT, $lUserAgent); 
	curl_setopt($lCurlHandler, CURLOPT_HEADER, 0);	
	curl_setopt($lCurlHandler, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($lCurlHandler, CURLOPT_FOLLOWLOCATION, 1);
	curl_setopt($lCurlHandler, CURLOPT_MAXREDIRS, 3);
	curl_setopt($lCurlHandler, CURLOPT_TIMEOUT, $pTimeout);
	//~ curl_setopt($lCurlHandler, CURLOPT_BUFFERSIZE, 512);
	
	if ($pCBF) {
		curl_setopt($lCurlHandler, CURLOPT_WRITEFUNCTION, $pCBF);
	}
	
	if(is_array($pPostFields)){
		curl_setopt($lCurlHandler, CURLOPT_POST, 1);
		curl_setopt($lCurlHandler, CURLOPT_POSTFIELDS, $pPostFields);	
	}
	$lResult = curl_exec($lCurlHandler);	
	//~ if ($_SERVER['REMOTE_ADDR'] == '193.194.140.198') {
		//~ echo $gBHLData . "!!!!" . $this->m_bulk_xml;
		//~ echo "!!!" . curl_error($lCurlHandler) . "!!!";
	//~ }
	curl_close($lCurlHandler);
	//~ var_dump($lResult);
	return $lResult;
}


function getTaxonMap($pTaxonName){
	$lUrl = TAXON_MAP_SRV . $pTaxonName;	
	$lQueryResult = executeExternalQuery($lUrl);	
	$lMapFound = false;
	$lResult = '<h2>' . getstr('admin.external_details_about_taxon.distributionMapTitle') . '</h2>';
	if( $lQueryResult ){		
		$lDom = new DOMDocument();	
		if($lDom->loadXML($lQueryResult)){
			$lXpath = new DOMXPath($lDom);
			$lXpathQuery = '/taxa/taxon/mapHTML';			
			$lXPathResult = $lXpath->query($lXpathQuery);
			if( $lXPathResult->length ){
				$lMapIframe = $lXPathResult->item(0);
				if( $lMapIframe ){			
					$lMapFound = true;
					$lResult .= $lMapIframe->textContent;					
				}
			}
		}
	}
	if( !$lMapFound ){
		$lResult .= getstr('admin.external_details_about_taxon.noMap');
	}
	return $lResult;
	
}


function getTaxonLinks($pTaxonName, $pLinksPerSource = 10){//Vryshta linkove kym statii za vyprosniq taxon
	//Za info http://eutils.ncbi.nlm.nih.gov/corehtml/query/static/esearch_help.html
	
	$lUrl = EUTILS_ESEARCH_SRV . 'term=' . str_replace(' ', '+', $pTaxonName) . '&retmode=xml&retmax=' . (int) $pLinksPerSource . '&tool=' . EUTILS_TOOL_NAME;	
	$lDataBases = array(EUTILS_PUBMED_DB, EUTILS_NUCLEOTIDE_DB);
	//~ $lDataBases = array(EUTILS_PUBMED_DB);//Bazite ot danni v koito tyrsim statii
	$lLinksExist = false;
	foreach($lDataBases as $lDataBaseName){
		$lCurrentDataseResults = '';
		$lSingleUrl = $lUrl . '&db=' . $lDataBaseName;		
		$lQueryResult = executeExternalQuery($lSingleUrl);	
		if( $lQueryResult ){
			$lDom = new DOMDocument();	
			$lDatabaseIds = array();
			if($lDom->loadXML($lQueryResult)){
				$lXpath = new DOMXPath($lDom);
				$lXpathQuery = '/eSearchResult/IdList/Id';			
				$lXPathResult = $lXpath->query($lXpathQuery);
				
				foreach( $lXPathResult as $lSingleId){//Vzimame id-tata i stroim linkove
					$lResourceId = $lSingleId->textContent;
					if( $lResourceId ){
						$lResourceLink = getTaxonResourceLink($lDataBaseName, $lResourceId);
						$lDatabaseIds[$lResourceId] = array('title' => $lResourceId, 'link' => $lResourceLink);
					}
				}
				
				if( is_array( $lDatabaseIds ) && count($lDatabaseIds) ){
					$lCurrentDatabaseHasResults = false;
					$lIds = array_keys($lDatabaseIds);
					if( is_array($lIds) && count($lIds) ){//Stroim title-i za linkovete
						
						$lTitleUrl = EUTILS_ESUMMARY_SRV . '&db=' . $lDataBaseName . '&id=' . implode(',', $lIds) . '&retmode=xml';						
						$lTitleQueryResult = executeExternalQuery($lTitleUrl);	
						if( $lTitleQueryResult ){
							$lTitleDom = new DOMDocument();								
							if($lTitleDom->loadXML($lTitleQueryResult)){								
								$lTitleXpath = new DOMXPath($lTitleDom);
								$lTitleXpathQuery = '/eSummaryResult/DocSum';
								$lElements = $lTitleXpath->query($lTitleXpathQuery);
								foreach( $lElements as $lSingleElement){
									$lIdXpath = './Id';
									$lIdXpathResult = $lTitleXpath->query($lIdXpath, $lSingleElement);
									if( $lIdXpathResult->length ){
										$lCurrentId = $lIdXpathResult->item(0)->textContent;
										$lCurrentTitleXpath = "./Item[@Name='Title']";
										$lCurrentTitleResult = $lTitleXpath->query($lCurrentTitleXpath, $lSingleElement);
										if( $lCurrentTitleResult->length ){
											$lCurrentTitle = $lCurrentTitleResult->item(0)->textContent;
											$lDatabaseIds[$lCurrentId]['title'] = $lCurrentTitle;
											
										}
									}
								}								
							}
						}
						foreach( $lDatabaseIds as $lResourceId => $lResourceData ){
							$lCurrentDatabaseHasResults = true;
							$lLinksExist = true;
							$lCurrentDataseResults .= '<a href="' . $lResourceData['link'] . '" target="_blank" title="' . $lResourceData['title'] . '">' . $lResourceData['title'] . '</a>';
						}
					}
				}
			}
		}
		if( $lCurrentDatabaseHasResults ){
			$lResult .= '<h3 class="linkDatabaseTitle">' . getstr('admin.external_details_about_taxon.linkDatabaseTitle' . $lDataBaseName) . '</h3>';
		}
		$lResult .= $lCurrentDataseResults;
	}
	$lResult = '<h2 class="taxonLinksTitle">' . getstr('admin.external_details_about_taxon.linksTitle') . '</h2>' . $lResult;
	if( !$lLinksExist ){
		$lResult .= getstr('admin.external_details_about_taxon.noLinks');	
	}
	$lResult = '<div class="taxonLinks">' . $lResult . '</div>';
	return $lResult;
}

function getTaxonResourceLink($pDatabase, $pResourceId){
	switch($pDatabase){
		case EUTILS_PUBMED_DB:{
			return PUBMED_LINK_PREFIX . $pResourceId;
		}
		case EUTILS_NUCLEOTIDE_DB:{
			return NUCLEOTIDE_LINK_PREFIX . $pResourceId;
		}
	}
}

function BuildPropertyLink($pRs){
	$lName = $pRs['property_name'];
	$lTypeId = (int) $pRs['type_id'];
	$lPropertyId = (int) $pRs['property_id'];
	$lHref = '';
	switch( $lTypeId ){
		case (int) PLACE_RULE_PROPERTY_TYPE:{
			$lHref = '/resources/autotag_rules/place_rules/edit.php?tAction=showedit&id=' . (int) $lPropertyId;
			break;
		}
		case (int) REGEXP_RULE_PROPERTY_TYPE:{
			$lHref = '/resources/autotag_rules/regular_expressions/edit.php?tAction=showedit&id=' . (int) $lPropertyId;
			break;
		}
		case (int) SOURCE_RULE_PROPERTY_TYPE:{
			$lHref = '/resources/autotag_rules/autotag_re_sources/edit.php?tAction=showedit&id=' . (int) $lPropertyId;
			break;
		}
	}	
	return '<a href="' . $lHref . '" target="_blank">' . $lName . '</a>';
}

function putUnfloat($pRownum, $pItemsonrow){
	if( ($pRownum % $pItemsonrow) == 0 )
		return '<div class="unfloat"></div>';
}

function ShowEntrezRecordsDbSubtreeLink($pTaxonName, $pTaxonId, $pDbName, $pCount){
	if(!(int) $pCount ){
		return '-';
	}
	return '<a href="' . ParseTaxonExternalLink($pTaxonName, NCBI_SUBTREE_LINK . '&term=txid' . $pTaxonId . '[Organism:exp]&db=' . $pDbName) . '">' . (int)$pCount . '</a>';

}

function ParseTaxonExternalLink($pTaxonName, $pLink, $pAddTaxonNameToEnd = false, $pPostForm = false, $pPostFields = false){
	$pTaxonName = rawurlencode($pTaxonName);
	$lLink = '/resources/articles/externalLink.php?taxon_name=' . $pTaxonName . '&url=' . rawurlencode($pLink);
	if( $pAddTaxonNameToEnd )
		$lLink .= $pTaxonName;
	if( $pPostForm )
		$lLink .= '&postform=1';
	if( $pPostFields )
		$lLink .= '&postfields=' . rawurlencode($pPostFields);
	return  $lLink;
}

function CutText($d, $len = 80) {
	$d = strip_tags($d);
	if (mb_strlen($d, 'UTF-8') < $len) return $d;
	$cut = mb_substr($d, 0, $len, 'UTF-8');
	return mb_substr($cut, 0, mb_strrpos($cut, ' ', 'UTF-8'), 'UTF-8') . '...';
}

function getLinkIframe($pUrl, $pPostForm, $pPostFields = ''){
	if( !$pPostForm ){//Normalna get zaqvka
		$lResult = '<iframe id="ext_link_iframe" name="ext_link_iframe" src="' . $pUrl . '" class="externalIframe"></iframe>';
	}else{
		$lBaseUrl = $pUrl;
		$lFields = parseStringPostfields($pPostFields);
		$lResult = '
			<iframe id="ext_link_iframe" name="ext_link_iframe" class="externalIframe"></iframe>
			<form name="ext_link_form" id="ext_link_form" action="' . $lBaseUrl . '" target="ext_link_iframe" method="post">
		';
		foreach( $lFields as $lFieldName => $lValue){
			$lResult .= '<input type="hidden" name="' . $lFieldName . '" value="' . $lValue . '" />';
		}
		$lResult .= '</form>
			<script>document.ext_link_form.submit()</script>
		';
	}
	return $lResult;	

}

function getBaseUrl($pUrl){//Връща базовото урл към което трябва да направим пост заявката напр от http://etaligent.net?query=a ще върне http://etaligent.net
	$lParsedUrl = parse_url($pUrl);
	return 'http://' . $lParsedUrl['host'] . $lParsedUrl['path'];
}

function getUrlPostFields($pUrl){//Връща масив с полетата които се съдържат в заявката от урл-а - напр. от http://etaligent.net?query=a ще върне array(query => a)
	$lParsedUrl = parse_url($pUrl);
	parse_str($lParsedUrl['query'], $lResult);	
	return $lResult;
}

function parseStringPostfields($pString){//Връща масив с полетата които се съдържат в стринга - напр. query=a ще върне array(query => a)
	$lFakeUrl = 'http://www.etaligent.net?' . $pString;
	return getUrlPostFields($lFakeUrl);
}

function ParsePubmedTaxonName($pTaxonName){//Parsva taxona taka 4e v pubmed da go tyrsi s AND, a ne s OR
	return str_replace(' ', ' AND ', $pTaxonName);//Zamenq intervalite s AND 
}

function GetTaxonGbifLinkAndId($pTaxonName){
	$lGbifMap = new ctaxonmap(array(
			'templs' => array(
				G_STARTRS => 'external_details.mapStart',
				G_ENDRS => 'external_details.mapEnd',
				G_ROWTEMPL => 'external_details.mapRow',
			),
			'cache' => 'extdetails_gbifmap',
			'cachetimeout' => CACHE_TIMEOUT_LENGTH,
			'taxon_name' => $pTaxonName,
		)
	);
	$lGbifMap->GetDataC();
	$lResult = array(
		'id' => $lGbifMap->GetVal('gbif_id'),
		'link' => $lGbifMap->GetVal('gbif_link')
	);
	return $lResult;
}

function GetTaxonMorphbankResultCount($pTaxonName){	
	$lMorph = new ctaxon_morphbank(
		array(
			'templs' => array(),
			'taxon_name' => $pTaxonName,
			'pagesize' => 1,
			'cache' => 'extdetails_morph',
			'cachetimeout' => CACHE_TIMEOUT_LENGTH,
		)
	);
	$lMorph->GetDataC();
	$lMorphRes = (int)$lMorph->m_recordCount;
	return $lMorphRes;
}

function GetTaxonLiasResultCount($pTaxonName){
	$lLias = new ctaxon_lias(array(
		'taxon_name' => $pTaxonName,
	));
	$lLias->GetDataC();
	$lResultFound = $lLias->GetResultCount();
	return $lResultFound;
}

function GetTaxonNcbiId($pTaxonName){
	$lNCBI =new ctaxon_ncbiinfo(
		array(	
			'ctype' => 'ctaxon_ncbiinfo',
			'icon_ajax_url' => AJAX_MENU_LINK_SRV . '?taxon_name=' . $pTaxonName . '&site_name=ncbi&type=2',
			'call_sub_ajax_queries' => 1,
			'templs' => array(
				G_STARTRS => 'external_details.ncbiStart',
				G_ENDRS => 'external_details.ncbiEnd',
				G_ROWTEMPL => 'external_details.ncbiRow',
			),
			'lineage_templs' => array(
				G_STARTRS => 'external_details.ncbiLineageStart',
				G_ENDRS => 'external_details.ncbiLineageEnd',
				G_ROWTEMPL => 'external_details.ncbiLineageRow',
			),
			'link_templs' => array(
				G_STARTRS => 'external_details.extLinksStart',
				G_ENDRS => 'external_details.extLinksEnd',
				G_ROWTEMPL => 'external_details.extLinksRow',
			),
			'link_ajax_templs' => array(
				G_DEFAULT => 'external_details.extLinksAjax',
			),
			'link_result_count' => 5,
			'link_database' => EUTILS_PUBMED_DB,
			'link_database_title' => 'PubMed',
			'entrezrecords_templs' => array(
				G_STARTRS => 'external_details.entrezRecordsStart',
				G_ENDRS => 'external_details.entrezRecordsEnd',
				G_ROWTEMPL => 'external_details.entrezRecordsRow',
			),
			'entrezrecords_ajax_templs' => array(
				G_DEFAULT => 'external_details.entrezRecordsAjax',
			),
			'entrez_records_allowed_databases' => array(
				EUTILS_PMC_DB => EUTILS_PMC_DISPLAY_NAME, 
				EUTILS_TAXONOMY_DB => '', 
				EUTILS_PROTEIN_DB => '',
				EUTILS_POPSET_DB => '', 
				EUTILS_NUCCORE_DB => EUTILS_NUCCORE_DISPLAY_NAME
			),
			'taxon_name' => $pTaxonName,
			'cache' => 'extdetails_ncbiinfo',
			'cachetimeout' => CACHE_TIMEOUT_LENGTH,
		)
	);
	$lNCBI->GetDataC();
	//~ var_dump($lNCBI);
	$lTaxonId = $lNCBI->GetVal('m_taxonid');
	return $lTaxonId;
}

function GetSingleSiteLinkArray($pTaxonName, $pSiteName){
	$lResArr = GetLinksArray($pTaxonName, false);
	$lResult = $lResArr[$pSiteName];
	
	if( $pSiteName == 'gbif' ){
		$lGbifData = GetTaxonGbifLinkAndId($pTaxonName);
		$lResult['dont_check_for_existence'] = true;
		if($lGbifData['id']){//Dobavqme gbif-a samo ako ima takyv rez v gbif
			$lResult['href'] = $lGbifData['link'];
			$lResult['results_exist'] = true;
		}else{
			$lResult['results_exist'] = false;
			$lResult['picsrc'] = $lResult['default_picsrc'];
		}
	}elseif( $pSiteName == 'morphbank'){
		$lMorphRes = GetTaxonMorphbankResultCount($pTaxonName);
		$lResult['dont_check_for_existence'] = true;
		if ((int)$lMorphRes > 0) {
			$lResult['results_exist'] = true;
		}else{
			$lResult['results_exist'] = false;
			$lResult['picsrc'] = $lResult['default_picsrc'];
		}
	}
	elseif( $pSiteName == 'ncbi'){
		$lTaxonId = GetTaxonNcbiId($pTaxonName);
		$lResult['isubio'] = false;
		$lResult['dont_check_for_existence'] = true;
		if ($lTaxonId) {
			$lResult['href'] = NCBI_TAXON_URL . $lTaxonId;
			$lResult['results_exist'] = true;
		}else{
			$lResult['results_exist'] = false;
			$lResult['picsrc'] = $lResult['default_picsrc'];
		}
	}elseif( $pSiteName == 'lias'){
		$lLiasRes = GetTaxonLiasResultCount($pTaxonName);
		$lResult['isubio'] = false;
		$lResult['dont_check_for_existence'] = true;
		if ((int)$lLiasRes > 0) {
			$lResult['results_exist'] = true;
		}else{
			$lResult['results_exist'] = false;
			$lResult['picsrc'] = $lResult['default_picsrc'];
		}
	}

	return $lResult;
}

function GetLinksArray($pTaxonName, $pScrapSomeLinks = true){	
	$pEncodedTaxonName = rawurlencode($pTaxonName);
	//~ var_dump($pTaxonName);
	//~ var_dump($pEncodedTaxonName);
	//~ echo '<br/>';
	$lResult = array(		
		'gbif' => array(
			'picsrc' => '/img/ext_details/gbif_logo.jpg',
			'default_picsrc' => '/img/ext_details/gbif_logo_BW.jpg',
			'title' => 'Global Biodiversity Information Facility',
			'isubio' => false,
			'ubio_title' => '',
			'show_if_not_found' => true,
			'href' => 'http://data.gbif.org/search/' . $pEncodedTaxonName,
			'default_href' => 'http://data.gbif.org/search/' . $pEncodedTaxonName,
			'postform' => false,
			'default_postform' => false,
		),
		'eol' => array(
			'picsrc' => '/img/ext_details/eol_logo.jpg',
			'default_picsrc' => '/img/ext_details/eol_logo_BW.jpg',
			'title' => 'Encyclopedia of Life',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.eol.org/search?q=' . $pEncodedTaxonName,	
			'default_href' => 'http://www.eol.org/search?q=' . $pEncodedTaxonName,	
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,	
		),
		'col' => array(
			'picsrc' => '/img/ext_details/col_logo.jpg',
			'default_picsrc' => '/img/ext_details/col_logo_BW.jpg',
			'title' => 'Catalogue of Life',
			'isubio' => false,
			'ubio_title' => UBIO_LINK_CATALOGOFLIFE_TITLE,
			'href' => 'http://www.catalogueoflife.org/search/all/key/' . $pEncodedTaxonName,
			'default_href' => 'http://www.catalogueoflife.org/search/all/key/' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'itis' => array(
			'picsrc' => '/img/ext_details/itis_logo.jpg',
			'default_picsrc' => '/img/ext_details/itis_logo_BW.jpg',
			'title' => 'Integrated Taxonomic Information System',
			'isubio' => true,
			'ubio_title' => UBIO_LINK_ITIS_TITLE,
			'href' => 'http://www.itis.gov/servlet/SingleRpt/SingleRpt',
			'postfields' => 'search_topic=all&search_kingdom=every&search_span=containing&categories=All&source=html&search_credRating=All&search_value=' . $pTaxonName, 
			'default_href' => 'http://www.itis.gov/servlet/SingleRpt/SingleRpt',
			'default_postfields' => 'search_topic=all&search_kingdom=every&search_span=containing&categories=All&source=html&search_credRating=All&search_value=' . $pTaxonName,
			'show_if_not_found' => true,
			'postform' => true,
			'default_postform' => true,
		),
		'species2000' => array(
			'picsrc' => '/img/ext_details/species2000_logo.jpg',
			'default_picsrc' => '/img/ext_details/species2000_logo_BW.jpg',
			'title' => 'Species 2000',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.sp2000.org/index.php?option=com_search&Itemid=99999999&submit=Search&searchphrase=any&ordering=newest&searchword=' . $pEncodedTaxonName,
			'default_href' => 'http://www.sp2000.org/index.php?option=com_search&Itemid=99999999&submit=Search&searchphrase=any&ordering=newest&searchword=' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'fa' => array(
			'picsrc' => '/img/ext_details/fa_logo.jpg',
			'default_picsrc' => '/img/ext_details/fa_logo_BW.jpg',
			'title' => 'Fauna Europaea',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.faunaeur.org',
			'default_href' => 'http://www.faunaeur.org',
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'worms' => array(
			'picsrc' => '/img/ext_details/worms_logo.jpg',
			'default_picsrc' => '/img/ext_details/worms_logo_BW.jpg',
			'title' => 'World Register of Marine Species',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.marinespecies.org/aphia.php?p=taxlist',
			'default_href' => 'http://www.marinespecies.org/aphia.php?p=taxlist',
			'postfields' => 'tComp=contains&searchpar=0&action=search&rSkips=0&marine=1&tName=' . $pTaxonName,
			'default_postfields' => 'tComp=contains&searchpar=0&action=search&rSkips=0&marine=1&tName=' . $pTaxonName,
			'show_if_not_found' => true,
			'postform' => true,
			'default_postform' => true,
		),
		'wikipedia' => array(
			'picsrc' => '/img/ext_details/wiki_logo.jpg',
			'default_picsrc' => '/img/ext_details/wiki_logo_BW.jpg',
			'title' => 'Wikipedia',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://en.wikipedia.org/w/index.php?search=' . $pEncodedTaxonName,
			'default_href' => 'http://en.wikipedia.org/w/index.php?search=' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'wikispecies' => array(
			'picsrc' => '/img/ext_details/wikispecies_logo.gif',
			'default_picsrc' => '/img/ext_details/wikispecies_logo_BW.gif',
			'title' => 'Wikispecies',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://species.wikimedia.org/wiki/' . $pEncodedTaxonName,
			'default_href' => 'http://species.wikimedia.org/wiki/' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'iucn' => array(
			'picsrc' => '/img/ext_details/iucn_logo.jpg',
			'default_picsrc' => '/img/ext_details/iucn_logo_BW.jpg',
			'title' => 'IUCN',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://iucn.org/search.cfm?uSearchTerm=' . $pEncodedTaxonName,
			'default_href' => 'http://iucn.org/search.cfm?uSearchTerm=' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'fungorum' => array(
			'picsrc' => '/img/ext_details/fungorum_logo.jpg',
			'default_picsrc' => '/img/ext_details/fungorum_logo_BW.jpg',
			'title' => 'Index Fungorum',
			'isubio' => true,
			'ubio_title' => UBIO_LINK_INDEXFUNGORUM_TITLE,
			'href' => 'http://www.indexfungorum.org/Names/Names.asp?SearchTerm=' . $pEncodedTaxonName,
			'default_href' => 'http://www.indexfungorum.org/Names/Names.asp?SearchTerm=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'ipni' => array(
			'picsrc' => '/img/ext_details/ipni_logo.jpg',
			'default_picsrc' => '/img/ext_details/ipni_logo_BW.jpg',
			'title' => 'International Plant Name Index',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.ipni.org/ipni/simplePlantNameSearch.do?find_wholeName=' . $pEncodedTaxonName,
			'default_href' => 'http://www.ipni.org/ipni/simplePlantNameSearch.do?find_wholeName=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'algaebase' => array(
			'picsrc' => '/img/ext_details/algaebase_logo.jpg',
			'default_picsrc' => '/img/ext_details/algaebase_logo_BW.jpg',
			'title' => 'Algaebase',
			'isubio' => true,
			'ubio_title' => UBIO_LINK_ALKAEBASE_TITLE,
			'href' => 'http://www.algaebase.org/search/species/',
			'default_href' => 'http://www.algaebase.org/search/species/?currentMethod=species&fromSearch=yes&sk=0&displayCount=20&sortBy=Genus&sortBy2=Species&-Search=Search&name=' . $pTaxonName,
			'postfields' => 'currentMethod=species&fromSearch=yes&sk=0&displayCount=20&sortBy=Genus&sortBy2=Species&-Search=Search&name=' . $pTaxonName,
			'default_postfields' => 'currentMethod=species&fromSearch=yes&sk=0&displayCount=20&sortBy=Genus&sortBy2=Species&-Search=Search&name=' . $pTaxonName,
			'show_if_not_found' => false,
			'postform' => true,
			'default_postform' => true,
		),
		'tropicos' => array(
			'picsrc' => '/img/ext_details/tropicos_logo.jpg',
			'default_picsrc' => '/img/ext_details/tropicos_logo_BW.jpg',
			'title' => 'Tropicos',
			'isubio' => false,
			'ubio_title' => UBIO_LINK_TROPICOS_TITLE,
			'href' => 'http://www.tropicos.org/NameSearch.aspx?name=' . $pEncodedTaxonName,
			'default_href' => 'http://www.tropicos.org/NameSearch.aspx?name=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'usda' => array(
			'picsrc' => '/img/ext_details/usda_logo.jpg',
			'default_picsrc' => '/img/ext_details/usda_logo_BW.jpg',
			'title' => 'PLANTS Database',
			'isubio' => true,
			'ubio_title' => UBIO_LINK_USDAPLANTS_TITLE,
			'href' => 'http://www.plants.usda.gov/java/nameSearch?mode=sciname&submit.x=10&submit.y=4&keywordquery=' . $pEncodedTaxonName,
			'default_href' => 'http://www.plants.usda.gov/java/nameSearch?mode=sciname&submit.x=10&submit.y=4&keywordquery=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'gymnosperm' => array(
			'picsrc' => '/img/ext_details/gymnosperm_logo.jpg',
			'default_picsrc' => '/img/ext_details/gymnosperm_logo_BW.jpg',
			'title' => 'The Gymnosperm Database',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.google.com/custom?ie=UTF-8&oe=UTF-8&cof=S%3Ahttp%3A%2F%2Fwww.conifers.org%2F%3BAH%3Acenter%3BL%3Ahttp%3A%2F%2Fwww.conifers.org%2Fzz%2Fgymn2.gif%3B&domains=conifers.org&sitesearch=conifers.org&&sitesearch=http%3A%2F%2Fwww.conifers.org&sa=Search+this+site&q=' . $pEncodedTaxonName,
			'default_href' => 'http://www.google.com/custom?ie=UTF-8&oe=UTF-8&cof=S%3Ahttp%3A%2F%2Fwww.conifers.org%2F%3BAH%3Acenter%3BL%3Ahttp%3A%2F%2Fwww.conifers.org%2Fzz%2Fgymn2.gif%3B&domains=conifers.org&sitesearch=conifers.org&&sitesearch=http%3A%2F%2Fwww.conifers.org&sa=Search+this+site&q=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'zoobank' => array(
			'picsrc' => '/img/ext_details/zoobank_logo.jpg',
			'default_picsrc' => '/img/ext_details/zoobank_logo_BW.jpg',
			'title' => 'ZooBank',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.zoobank.org/Search.aspx?search=' . $pEncodedTaxonName,
			'default_href' => 'http://www.zoobank.org/Search.aspx?search=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'tol' => array(
			'picsrc' => '/img/ext_details/tol_logo.jpg',
			'default_picsrc' => '/img/ext_details/tol_logo_BW.jpg',
			'title' => 'Tree of Life',
			'isubio' => true,
			'ubio_title' => UBIO_LINK_TOL_TITLE,
			'href' => 'http://tolweb.org/tree/home.pages/searchresults.html?cx=009557456284541951685%3A50nf_5tpvuq&cof=FORID%3A9&ie=UTF-8&sa=Search&q=' . $pEncodedTaxonName,
			'default_href' => 'http://tolweb.org/tree/home.pages/searchresults.html?cx=009557456284541951685%3A50nf_5tpvuq&cof=FORID%3A9&ie=UTF-8&sa=Search&q=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'treebase' => array(
			'picsrc' => '/img/ext_details/treebase_logo.jpg',
			'default_picsrc' => '/img/ext_details/treebase_logo_BW.jpg',
			'title' => 'TreeBase',
			'isubio' => true,
			'ubio_title' => UBIO_LINK_TREEBASE_TITLE,
			'href' => 'http://www.treebase.org/treebase-web/search/studySearch.html',
			'default_href' => 'http://www.treebase.org/treebase-web/search/studySearch.html',
			'postfields' => 'formName=searchKeyword&searchButton=textKeyword&query=&searchTerm=' . $pTaxonName,
			'default_postfields' => 'formName=searchKeyword&searchButton=textKeyword&query=&searchTerm=' . $pTaxonName,
			'show_if_not_found' => false,
			'postform' => true,
			'default_postform' => true,
		),		
		'landcare' => array(
			'picsrc' => '/img/ext_details/landcare_logo.jpg',
			'default_picsrc' => '/img/ext_details/landcare_logo_BW.jpg',
			'title' => 'Landcare Research',
			'isubio' => true,
			'ubio_title' => UBIO_LINK_LANDCARE_TITLE,
			'default_href' => 'http://www.landcareresearch.co.nz/search/search.asp?zoom_cat=-1&Submit=GO&zoom_query=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'chilobase' => array(
			'picsrc' => '/img/ext_details/chilobase_logo.jpg',
			'default_picsrc' => '/img/ext_details/chilobase_logo_BW.jpg',
			'title' => 'Chilobase',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://chilobase.bio.unipd.it/',
			'default_href' => 'http://chilobase.bio.unipd.it/',
			'postfields' => 'TYPE=beginning+with&WORDS=' . $pTaxonName,
			'default_postfields' => 'TYPE=beginning+with&WORDS=' . $pTaxonName,
			'show_if_not_found' => false,
			'postform' => true,
			'default_postform' => true,
		),
		'hymenopterans' => array(
			'picsrc' => '/img/ext_details/hymenoptera.gif',
			'default_picsrc' => '/img/ext_details/hymenoptera_BW.gif',
			'title' => 'Hymenoptera Name Server',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://osuc.biosci.ohio-state.edu/hymDB/nomenclator.name_entry?Submit=Submit+Query&text_entry=' . $pEncodedTaxonName,
			'default_href' => 'http://osuc.biosci.ohio-state.edu/hymDB/nomenclator.name_entry?Submit=Submit+Query&text_entry=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),		
		'fishbase' => array(
			'picsrc' => '/img/ext_details/fishbase_logo.jpg',
			'default_picsrc' => '/img/ext_details/fishbase_logo_BW.jpg',
			'title' => 'FishBase',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.fishbase.org/NomenClature/ScientificNameSearchList.php',
			'default_href' => 'http://www.fishbase.org/NomenClature/ScientificNameSearchList.php',
			'postfields' => 'Language=English&crit1_fieldname=SYNONYMS.SynGenus&crit1_fieldtype=CHAR&crit2_fieldname=SYNONYMS.SynSpecies&crit2_fieldtype=CHAR&crit1_operator=EQUAL&crit1_value=&crit2_operator=EQUAL&crit2_value=&gs=' . $pTaxonName . '&group=summary',
			'default_postfields' => 'Language=English&crit1_fieldname=SYNONYMS.SynGenus&crit1_fieldtype=CHAR&crit2_fieldname=SYNONYMS.SynSpecies&crit2_fieldtype=CHAR&crit1_operator=EQUAL&crit1_value=&crit2_operator=EQUAL&crit2_value=&gs=' . $pTaxonName . '&group=summary',
			//~ 'dont_check_for_existence' => true,
			'show_if_not_found' => false,
			'postform' => true,
			'default_postform' => true,
		),
		'ncbi' => array(
			'picsrc' => '/img/ext_details/ncbi_logo.jpg',
			'default_picsrc' => '/img/ext_details/ncbi_logo_BW.jpg',
			'title' => 'National Center for Biotechnology Information',
			'isubio' => true,
			'ubio_title' => UBIO_LINK_NCBI_TITLE,
			'href' => 'http://www.ncbi.nlm.nih.gov/gquery/?term=' . $pEncodedTaxonName,
			'default_href' => 'http://www.ncbi.nlm.nih.gov/gquery/?term=' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'bold' => array(
			'picsrc' => '/img/ext_details/bold_logo.jpg',
			'default_picsrc' => '/img/ext_details/bold_logo_BW.jpg',
			'title' => 'Barcode of Life',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://boldsystems.org/views/taxbrowser.php?taxon=' . $pEncodedTaxonName,
			'default_href' => 'http://boldsystems.org/views/taxbrowser.php?taxon=' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'morphbank' => array(
			'picsrc' => '/img/ext_details/morphbank_logo.jpg',
			'default_picsrc' => '/img/ext_details/morphbank_logo_BW.jpg',
			'title' => 'Morphbank',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.morphbank.net/MyManager/?keywords=' . $pEncodedTaxonName,
			'default_href' => 'http://www.morphbank.net/MyManager/?keywords=' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'wikimedia' => array(
			'picsrc' => '/img/ext_details/wikimedia_logo.jpg',
			'default_picsrc' => '/img/ext_details/wikimedia_logo_BW.jpg',
			'title' => 'Wikimedia',
			'isubio' => false,
			'ubio_title' => '',
			'default_href' => 'http://commons.wikimedia.org/wiki/' . $pEncodedTaxonName,
			'href' => 'http://commons.wikimedia.org/wiki/' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'yahoo_images' => array(
			'picsrc' => '/img/ext_details/yahoo_logo.jpg',
			'default_picsrc' => '/img/ext_details/yahoo_logo_BW.jpg',
			'title' => 'Yahoo',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://images.search.yahoo.com/search/images;_ylt=A0WTb_moq.5LsmgAdzuLuLkF?ei=utf-8&iscqry=&fr=sfp&p=' . $pEncodedTaxonName,
			'default_href' => 'http://images.search.yahoo.com/search/images;_ylt=A0WTb_moq.5LsmgAdzuLuLkF?ei=utf-8&iscqry=&fr=sfp&p=' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'google_images' => array(
			'picsrc' => '/img/ext_details/google_logo.jpg',
			'default_picsrc' => '/img/ext_details/google_logo_BW.jpg',
			'title' => 'Google',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.google.com/images?hl=en&source=imghp&gbv=2&aq=f&aqi=g2&aql=&oq=&gs_rfai=&q=' . $pEncodedTaxonName,
			'default_href' => 'http://www.google.com/images?hl=en&source=imghp&gbv=2&aq=f&aqi=g2&aql=&oq=&gs_rfai=&q=' . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'google_scholar' => array(
			'picsrc' => '/img/ext_details/google_logo.jpg',
			'default_picsrc' => '/img/ext_details/google_logo_BW.jpg',
			'title' => 'GoogleScholar',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://scholar.google.com/scholar?q=' . $pEncodedTaxonName,
			'default_href' => 'http://scholar.google.com/scholar?q=' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'pubmed' => array(
			'picsrc' => '/img/ext_details/pubmed_logo.jpg',
			'default_picsrc' => '/img/ext_details/pubmed_logo_BW.jpg',
			'title' => 'PubMed',
			'isubio' => false,
			'ubio_title' => '',
			'href' => NCBI_SUBTREE_LINK . '&db=' . EUTILS_PUBMED_DB . '&term=' . rawurlencode(ParsePubmedTaxonName($pTaxonName)),
			'default_href' => NCBI_SUBTREE_LINK . '&db=' . EUTILS_PUBMED_DB . '&term=' . rawurlencode(ParsePubmedTaxonName($pTaxonName)),
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'biodev' => array(
			'picsrc' => '/img/ext_details/biodev_logo.jpg',
			'default_picsrc' => '/img/ext_details/biodev_logo_BW.jpg',
			'title' => 'Biodiversity Heritage Library',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.biodiversitylibrary.org/Search.aspx?searchCat=&searchTerm=' . $pEncodedTaxonName,
			'default_href' => 'http://www.biodiversitylibrary.org/Search.aspx?searchCat=&searchTerm=' . $pEncodedTaxonName,
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'biolib' => array(
			'picsrc' => '/img/ext_details/biolib_logo.jpg',
			'default_picsrc' => '/img/ext_details/biolib_logo_BW.jpg',
			'title' => 'BioLib',
			'isubio' => false,
			'ubio_title' => UBIO_LINK_BIOLIB_TITLE,
			'href' => 'http://www.biolib.cz/en/formsearch/?action=execute&string=' . $pEncodedTaxonName . '&searchtype=2&searchrecords=1&searchsynonyms=1&searchvnames=1&selecttaxonid=null&taxonid=',
			'href' => 'http://www.biolib.cz/en/formsearch/?action=execute&string=' . $pEncodedTaxonName . '&searchtype=2&searchrecords=1&searchsynonyms=1&searchvnames=1&selecttaxonid=null&taxonid=',
			'show_if_not_found' => true,
			'postform' => false,
			'default_postform' => false,
		),
		'ubio' => array(
			'picsrc' => '/img/ext_details/ubio_logo.jpg',
			'default_picsrc' => '/img/ext_details/ubio_logo_BW.jpg',
			'title' => 'uBio',
			'isubio' => false,
			'ubio_title' => '',
			'href' => 'http://www.ubio.org/browser/search.php?search_all=' . $pEncodedTaxonName,
			'default_href' => 'http://www.ubio.org/browser/search.php?search_all=' . $pEncodedTaxonName,			
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'plazi' => array(
			'picsrc' => '/img/ext_details/plazi_logo.jpg',
			'default_picsrc' => '/img/ext_details/plazi_logo_BW.jpg',
			'title' => 'Plazi',
			'isubio' => false,
			'href' => 'http://plazi.org:8080/GgSRS/search?taxonomicName.isNomenclature=isNomenclature&taxonomicName.exactMatch=exactMatch&taxonomicName.taxonomicName=' . $pEncodedTaxonName,
			'default_href' => 'http://plazi.org:8080/GgSRS/search?taxonomicName.isNomenclature=isNomenclature&taxonomicName.exactMatch=exactMatch&taxonomicName.taxonomicName=' . $pEncodedTaxonName,			
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'lias' => array(
			'picsrc' => '/img/ext_details/lias_logo.jpg',
			'default_picsrc' => '/img/ext_details/lias_logo_BW.jpg',
			'title' => 'Lias',
			'isubio' => false,
			'href' => LIAS_IFRAME_URL . $pEncodedTaxonName,
			'default_href' => LIAS_IFRAME_URL . $pEncodedTaxonName,
			'show_if_not_found' => false,
			'postform' => false,
			'default_postform' => false,
		),
		'diptera' => array(
			'picsrc' => '/img/ext_details/diptera_logo.jpg',
			'default_picsrc' => '/img/ext_details/diptera_logo_BW.jpg',
			'title' => 'Diptera',
			'isubio' => false,
			'ubio_title' => '',
			//~ 'href' => 'http://130.225.211.25//diptera/names/FMPro?-db=names.fp5&-lay=WWW+Detail&-format=resultNo.htm&-op=&Name=' . $pEncodedTaxonName . '&-op=&author=&-op=&year=&-op=&kind=&-op=&Family=&-op=&ValidName=&-sortfield=unsorted&-sortorder=ascending&-lop=or&-max=10&-find=Start+Search',
			
			//~ 'href' => 'http://130.225.211.25/diptera/names/FMPro',
			//~ 'default_href' => 'http://130.225.211.25/diptera/names/FMPro',
			//~ 'postfields' => '-db=names.fp5&-lay=WWW+Detail&-format=NomenclatorResult.html&-op=contains&Name=' . $pEncodedTaxonName . '&-op=&author=&-op=&year=&-op=&kind=&-op=&Family=&-op=&ValidName=&-sortfield=unsorted&-sortorder=ascending&-lop=and&-max=10&-find=Start+Search',
			//~ 'default_postfields' => '-db=names.fp5&-lay=WWW+Detail&-format=NomenclatorResult.html&-op=contains&Name=' . $pEncodedTaxonName . '&-op=&author=&-op=&year=&-op=&kind=&-op=&Family=&-op=&ValidName=&-sortfield=unsorted&-sortorder=ascending&-lop=and&-max=10&-find=Start+Search',
			//~ 'postform' => true,
			//~ 'default_postform' => true,
			'href' => 'http://130.225.211.25/diptera/names/FMPro?-db=names.fp5&-format=nomenclatorresult.html&-lay=www%20detail&-sortfield=unsorted&-op=cn&Name=' . $pEncodedTaxonName . '&-max=10&-find=&-lop=and',
			'default_href' => 'http://130.225.211.25/diptera/names/FMPro?-db=names.fp5&-format=nomenclatorresult.html&-lay=www%20detail&-sortfield=unsorted&-op=cn&Name=' . $pEncodedTaxonName . '&-max=10&-find=&-lop=and',
			'postform' => false,
			'default_postform' => false,
			'show_if_not_found' => false,
		),		
	);
	if( $pScrapSomeLinks ){//Ako e ukazan tozi parametyr vednaga se tyrsqt saitove za nqkoi obekti - iz4isleniqta se bavqt
		$lGbifData = GetTaxonGbifLinkAndId($pTaxonName);
		$lResult['gbif']['dont_check_for_existence'] = true;
		$lResult['gbif']['isubio'] = false;
		if($lGbifData['id']){//Dobavqme gbif-a samo ako ima takyv rez v gbif
			$lResult['gbif']['href'] = $lGbifData['link'];
			$lResult['gbif']['results_exist'] = true;
		}else{
			$lResult['gbif']['picsrc'] = $lResult['gbif']['default_picsrc'];
			$lResult['gbif']['results_exist'] = false;
		}
		
		$lMorphRes = GetTaxonMorphbankResultCount($pTaxonName);
		$lResult['morphbank']['dont_check_for_existence'] = true;
		$lResult['morphbank']['isubio'] = false;
		if ((int)$lMorphRes > 0) {
			$lResult['morphbank']['results_exist'] = true;
		}else{
			$lResult['morphbank']['picsrc'] = $lResult['morphbank']['default_picsrc'];
			$lResult['morphbank']['results_exist'] = false;
		}
		
		$lTaxonId = GetTaxonNcbiId($pTaxonName);
		$lResult['ncbi']['isubio'] = false;
		$lResult['ncbi']['dont_check_for_existence'] = true;
		if ($lTaxonId) {
			$lResult['ncbi']['href'] = NCBI_TAXON_URL . $lTaxonId;
			$lResult['ncbi']['results_exist'] = true;
		}else{
			$lResult['ncbi']['picsrc'] = $lResult['ncbi']['default_picsrc'];
			$lResult['ncbi']['results_exist'] = false;
		}
		
		$lLiasRes = GetTaxonLiasResultCount($pTaxonName);
		$lResult['lias']['isubio'] = false;
		$lResult['lias']['dont_check_for_existence'] = true;
		if ((int)$lLiasRes > 0) {
			$lResult['lias']['results_exist'] = true;
		}else{
			$lResult['lias']['results_exist'] = false;
			$lResult['lias']['picsrc'] = $lResult['lias']['default_picsrc'];
		}
		
	}
	return $lResult;
}

function getSitesMatchArray($pTaxonName){
	//Za vseki sait pazim masiv ot RegExp-ove, kato ako matchnat vsi4ki - nqma rezultat
	$pTaxonName = preg_quote($pTaxonName, '/');
	$lResult = array(		
		'gbif' => array(
			'<h9>A$A<\/h9>',
		),
		'eol' => array(
			'<h3>No\s+search\s+results\s+were\s+found<\/h3>',
		),
		'col' => array(
			'<div\s+class="results_counter"\s+align="right">\s+Records\s+found:\s+0<\/div>',
		),
		'species2000' => array(
			'Total\s*0\s*results\s*found\.\s*',
		),		
		'worms' => array(
			'No\s+taxa\s+found\s+that\s+satisfy\s+the\s+criteria\s+specified\s+in\s+the\s+previous screen\.',
		),
		'wikipedia' => array(
			'There\s+were\s+no\s+results\s+matching\s+the\s+query\.',
		),
		'wikispecies' => array(
			'There\s+is\s+currently\s+no\s+text\s+in\s+this\s+page\.'
		),
		'iucn' => array(
			'<div\s*class="results"\s*>\s*No\s*results found!',
		),		
		'ipni' => array(
			'((<b>No\s+Plant\s+Names\s+were\s+found\s+in\s+IPNI\s+matching\s+these\s+search\s+terms\.<\/b>)|(Full\s+name\s+is\s+invalid\.))',
		),		
		'gymnosperm' => array(
			'<br>Your\s+search\s+-\s+<b>' . $pTaxonName . '<\/b>\s+-\s+did\s+not\s+match\s+any\s+documents\.\s+\s+<br>',
		),
		'zoobank' => array(
			'<span\s+id="ctl00_ContentPlaceHolder_ActResults"><h3>No\s+Matching\s+Nomenclatural\s+Acts\s+Found\.<\/h3><\/span>',
			'<span\s+id="ctl00_ContentPlaceHolder_PubResults"><h3>No\s+Matching\s+Publications\s+Found\.<\/h3><\/span>',
			'<span\s+id="ctl00_ContentPlaceHolder_AuthResults"><h3>No\s+Matching\s+Authors\s+Found\.<\/h3><\/span>',
		),		
		'chilobase' => array(
			'<TR><TD\s+align=center\s+valign=top>\s+<TABLE\s+border="0"\s+cellspacing="0"\s+cellpadding="2"\s+width="100%">\s+<TR><TD\s+valign=top\s+nowrap>\s+<BR><BR><CENTER>No\s+results!<\/CENTER><BR><BR>\s+<\/TD><\/TR>\s+<\/TABLE>',
		),
		'hymenopterans' => array(
			//~ 'The\s+name\s+entered,\s+<strong>' . $pTaxonName . '<\/strong>,\s+was\s+not\s+found\s+in\s+the\s+database\.\s+Please\s+check\s+the\s+spelling.\s+We\s+would\s+appreciate\s+hearing\s+of\s+names\s+that\s+are\s+not\s+recorded\.',
			'(The\s+name\s+entered,\s+<strong>' . $pTaxonName . '<\/strong>,\s+was\s+not\s+found\s+in\s+the\s+database\.\s+Please\s+check\s+the\s+spelling.\s+We\s+would\s+appreciate\s+hearing\s+of\s+names\s+that\s+are\s+not\s+recorded\.)|(\<TABLE\s+BORDER\=1\s+BGCOLOR\="#AACCFF"\s+CELLPADDING\=5\>\s+\<TR\>\<TD\s+COLSPAN\=2\s+BGCOLOR\="#AACCFF"\s+ALIGN\=center\s+BORDER\=1\>\s+\<BR\>\s+\<TABLE\s+CELLPADDING\=5\s+border\=0\>\<TR\>\<TD\>\s+\<IMG\s+SRC\="http\:\/\/iris\.biosci\.ohio-state\.edu\/gifs\/wasp2\.gif"\>\<\/td\>\s+\<TD\>\<center\>\<H2\>\<FONT\s+color\="#006600"\>\<STRONG\>Hymenoptera\s+Name\s+Server\<\/STRONG\>\<\/FONT\>\<BR\>\s+\<FONT\s+SIZE\=-1\s+color\="#006600"\>\<em\>&nbsp;&nbsp;&nbsp;version\s+1\.5\s+&nbsp;&nbsp;&nbsp;19\.xii\.2007\<\/EM\>\<\/FONT\>\<\/center\>\<\/H2\>\<\/TD\>\<\/TR\>\<\/TABLE\>\<\/TD\>\<\/TR\>\s+\<\/TABLE\>)',
			//~ '\<TABLE\s+BORDER\=1\s+BGCOLOR\="#AACCFF"\s+CELLPADDING\=5\>\s+\<TR\>\<TD\s+COLSPAN\=2\s+BGCOLOR\="#AACCFF"\s+ALIGN\=center\s+BORDER\=1\>\s+\<BR\>\s+\<TABLE\s+CELLPADDING\=5\s+border\=0\>\<TR\>\<TD\>\s+\<IMG\s+SRC\="http\:\/\/iris\.biosci\.ohio-state\.edu\/gifs\/wasp2\.gif"\>\<\/td\>\s+\<TD\>\<center\>\<H2\>\<FONT\s+color\="#006600"\>\<STRONG\>Hymenoptera\s+Name\s+Server\<\/STRONG\>\<\/FONT\>\<BR\>\s+\<FONT\s+SIZE\=-1\s+color\="#006600"\>\<em\>&nbsp;&nbsp;&nbsp;version\s+1\.5\s+&nbsp;&nbsp;&nbsp;19\.xii\.2007\<\/EM\>\<\/FONT\>\<\/center\>\<\/H2\>\<\/TD\>\<\/TR\>\<\/TABLE\>\<\/TD\>\<\/TR\>\s+\<\/TABLE\>',
		),		
		'bold' => array(
			'The\s+name\s+you\s+requested\s+could\s+not\s+be\s+found\.',
		),		
		'wikimedia' => array(
			'(<div\s+class="noarticletext">\s+<p>This\s+page\s+does\s+not\s+currently\s+exist\.\s+You\s+can\s+)|' . 
			'(\<p\>\<span\s+class\="plainlinks\s+nourlexpansion"\>This\s+page\s+does\s+not\s+currently\s+exist\.\s+You\s+can)',
		),
		'yahoo_images' => array(
			'<div\s+class=yschalrtz>We\s+did\s+not\s+find\s+results\s+for\s+"<strong>' . $pTaxonName . '<\/strong>"',
		),
		'google_images' => array(
			'Your\s+search\s+-\s+<b>' . $pTaxonName . '<\/b>\s+-\s+did\s+not\s+match\s+any\s+documents\.',
		),
		'google_scholar' => array(
			'Your\s+search\s+-\s+<b>' . $pTaxonName . '<\/b>\s+-\s+did\s+not\s+match\s+any\s+articles\.',
		),		
		'biodev' => array(
			'<span\s+class="pageheader">Search\s+Results\s+for\s+"<span\s+id="ctl00_mainContentPlaceHolder_searchResultsLabel">' . $pTaxonName . '<\/span>"<\/span>',
			'<span\s+id="ctl00_mainContentPlaceHolder_spanTitleSummary">\s+<a\s+href="#Titles">Titles<\/a>\s+found\s+:\s+0<br\s+\/><\/span>',
			'<span\s+id="ctl00_mainContentPlaceHolder_spanAuthorSummary">\s+<a\s+href="#Authors">Authors<\/a>\s+found\s+:\s+0<br\s+\/><\/span>',
			'<span\s+id="ctl00_mainContentPlaceHolder_spanNameSummary">\s+<a\s+href="#Names">Names<\/a>\s+found\s+:\s+0<br\s+\/><\/span>',
			'<span\s+id="ctl00_mainContentPlaceHolder_spanSubjectSummary">\s+<a\s+href="#Subjects">Subjects<\/a>\s+found\s+:\s+0<br\s+\/><\/span>',
			
		),		
		'ubio' => array(
			'Search\s+Results<\/span><br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;No\s+Results\s+for\s+<b>' . $pTaxonName . '<\/b><br><br><br>',
		),
		'diptera' => array(
			'<P\s+ALIGN=CENTER><B><FONT\s+SIZE="\+1"\s+COLOR="#FFFFFF">No\s+Records\s+Found<\/FONT><\/B>',
		),
		'fishbase' => array(
			'<table\s+border="1"\s+cellpadding="1"\s+cellspacing="1"\s+align="center"\s+width="800">\s+<tr\s+bgcolor="EAF2F7"\s+class="t_header2">\s+<td\s+width="200"\s+height="25"><div\s+align="center"><strong>&nbsp;\s+Scientific\s+Name<\/strong><\/div><\/td>\s+<td\s+width="200"><div\s+align="center"><strong>&nbsp;\s+Author<\/strong><\/div><\/td>\s+<td\s+width="200"><div\s+align="center"><strong>&nbsp;\s+Valid\s+Name<\/strong><\/div><\/td>\s+<td\s+width="200"><div\s+align="center"><strong>&nbsp;\s+English\s+Name<\/strong><\/div><\/td>\s+<\/tr>\s+<\/table>\s+<table\s+border="0"\s+cellpadding="1"\s+cellspacing="1"\s+align="center"\s+width="800">\s+<tr>\s+<td\s+colspan=4\s+align="center"><span\s+class="t_value2">\s+[\s+<a\s+href="javascript:history.go(-1)">Go\s+Back<\/a>\s+]\s+[\s+<a\s+href="search.php">Go\s+Search<\/a>\s+]\s+[\s+<a\s+href="#GoTop">Go\s+Top\s+<\/a>]<\/span><\/td>\s+<\/tr>\s+<\/table>',
		),
		'tropicos' => array('<span\s+class="AlertText">No\s+result\s+were\s+found<\/span>'
		),
		'biolib' => array(
			'<h3>Scientific\s+names<\/h3>\s+<div\s+class="clbarl2"><div\s+class="clbarbodyl2">\s+No\s+records\s+found<\/div><\/div>',
			'<h3>Vernacular\s+names<\/h3>\s+<div\s+class="clbarl2"><div\s+class="clbarbodyl2">\s+No\s+records\s+found<\/div><\/div>'
		),
		'pubmed' => array(
			'\<li\s+class\="info"\>No\s+items\s+found\.\<\/li\>',
		),
		'plazi' => array(
			'\<td\s+class\="searchErrorMessage"\>\s*No\s+treatment\s+yet\s+on\s+plazi\:\s+But\s+you\s+can\s+help\s+to\s+make\s+it\s+accessible\!\<\/td\>\s+\<\/tr\>',
		),
		'gbif' => array(
			'\<span\s+class\="moreMatches"\>No\s+scientific\s+names\s+matching\s+\<span\s+class\="subject"\>"' . $pTaxonName . '"\<\/span\>\<\/span\>',
			'\<span\s+class\="moreMatches"\>No\s+common\s+names\s+matching\s+\<span\s+class\="subject"\>"' . $pTaxonName . '"\<\/span\>\<\/span\>',
			'\<span\s+class\="moreMatches"\>No\s+countries\s+with\s+names\s+matching\s+\<span\s+class\="subject"\>"' . $pTaxonName . '"\<\/span\>\<\/span\>',
			'\<span\s+class\="moreMatches"\>No\s+datasets\s+with\s+names\s+matching\s+\<span\s+class\="subject"\>"' . $pTaxonName . '"\<\/span\>\<\/span\>',
		),
		'morphbank' => array(
			'display\s+Results:\s+no\s+rows!\<br\/\>',
		),
	);
	return $lResult;
}

function showLinksMenuLastRowClass($pRecords, $pRownum, $pClassName){
	if((int) $pRecords == (int) $pRownum )
		return $pClassName;
}

function showExtLinksMenuFirstRowClass($pRownum, $pClassName){
	if(1 == (int) $pRownum )
		return $pClassName;
}

function showImageIfSrcExists($pSrc, $pClass = 'noBorder'){
	if( trim($pSrc)){
		return '<img class="' . $pClass . '" src="' . $pSrc . '"></img>';
	}
}

function putColumnExceptOnLastRow($pRownum, $pRecords){	
	if((int) $pRownum != (int) $pRecords ){
		return ';';
	}
}

function parseIndesignXml($pXml, $pReplaceBrSymbol){
	global $G_INDESIGN_TAGS_SPLIT;
	global $gEcmsLibRequest;
	//Loadvame XML-a za da moje da go vzemem s hubav output - s neobhodimite intervali i dyrvovidna struktura
	
	if( !$gEcmsLibRequest )
		return GetFormattedXml($pXml, $pReplaceBrSymbol);	
	$lDOM = new DOMDocument("1.0");	
	$lDOM->preserveWhiteSpace = true;	
	if (!$lDOM->loadXML($pXml))
		return $pXml;
	
	parseIndesignXmlIgnoreTags($lDOM);	
	
	parseIndesignXmlBreakTags($lDOM);	
	//~ exit;

	return GetFormattedXml($lDOM->saveXML(), $pReplaceBrSymbol);
}
//Premestva vsi4ki element childove na opredeleni tagove predi samite tqh i sled tova trie tezi tagove
function parseIndesignXmlIgnoreTags(&$pXmlDom){
	$lXpath = new DOMXPath($pXmlDom);
	$lIgnoreQuery = '//' . IGNORE_TAG_NAME;
	$lIgnoreNodes = $lXpath->query($lIgnoreQuery);
	for( $i = $lIgnoreNodes->length - 1; $i >= 0; --$i){
		$lCurrentNode = $lIgnoreNodes->item($i);
		$lCurrentChild = $lCurrentNode->firstChild;
		$lParent = $lCurrentNode->parentNode;
		while($lCurrentChild){
			$lChildToAppend = $lCurrentChild;			
			$lCurrentChild = $lCurrentChild->nextSibling;
			if( $lChildToAppend->nodeType == XML_ELEMENT_NODE || $lChildToAppend->nodeType == XML_COMMENT_NODE  ){//Obrabotvame samo element i comment node-ovete 
				$lParent->insertBefore($lChildToAppend, $lCurrentNode);
			}			
		}
		$lParent->removeChild($lCurrentNode);
	}
}
//Splitva dadeni nodove, koito sydyrjat split node child. pTagsToSplit - imenata na tagovete sred koito tyrsim
function parseIndesignXmlBreakTags(&$pXmlDom){	
	$lXPaths = getBreakTagsXpaths();
	if( is_array( $lXPaths ) ){
		$lXpath = new DOMXPath($pXmlDom);
		foreach( $lXPaths as $lRuleId => $lRuleData ){
			$lCurrentXPath = $lRuleData['xpath'];
			$lXPathNodes = $lXpath->query($lCurrentXPath);			
			for( $i = $lXPathNodes->length - 1; $i >= 0; --$i ){
				$lParentNode = $lXPathNodes->item($i);
				$lTagQuery = './/' . SPLIT_TAG_NAME;
				$lNodesToSplit = $lXpath->query($lTagQuery, $lParentNode);				
				for( $j = $lNodesToSplit->length - 1; $j >= 0; --$j ){
					$lCurrentClimb = $lRuleData['climb_up'];
					$lCurrentSplitNode = $lNodesToSplit->item($j);
					$lCurrentNode = $lCurrentSplitNode;
					$lNewNode = null;
					$lSiblingFound = false;
					while($lCurrentNode && $lCurrentNode !== $lParentNode ){//Obikalqme nadolu po dyrvoto i slagame node-ovete v nov node					
						$lNewParent = tagSplitProcessNodeLevel($pXmlDom, $lSiblingFound, $lNewNode, $lCurrentNode);
					}				
					
					while($lCurrentNode && $lCurrentNode->parentNode != $pXmlDom && $lCurrentClimb > 0){
						$lNewParent = tagSplitProcessNodeLevel($pXmlDom, $lSiblingFound, $lNewNode, $lCurrentNode);
						$lCurrentClimb--;
					}
					
					if( $lNewNode && $lSiblingFound ){					
						$lNextSibling = $lCurrentNode->nextSibling;					
						if( $lNextSibling ){
							$lCurrentNode->parentNode->insertBefore( $lNewParent, $lNextSibling );
						}else{
							$lCurrentNode->parentNode->appendChild( $lNewParent );
						}
					}
					
				}
			}
			
		}
	}
	//~ exit;
}

//Обработва дадено ниво във възела, в който има сплит таг - обикаля всички следващи sibling-и на това ниво и ги премества в новия възел, който ще се добави след текущия 
function tagSplitProcessNodeLevel(&$pXmlDom, &$pSiblingFound, &$pNewNode, &$pCurrentNode){	
	if( $pCurrentNode->parentNode ){		
		$lNewParent = $pXmlDom->createElement($pCurrentNode->parentNode->nodeName);		
		if( $pNewNode )
			$lNewParent->appendChild( $pNewNode );
		$lCurrentSibling = $pCurrentNode->nextSibling;
		
		while( $lCurrentSibling ){
			$pSiblingFound = true;
			if( $lCurrentSibling->nodeType == XML_ELEMENT_NODE  || $lCurrentSibling->nodeType == XML_TEXT_NODE || $lCurrentSibling->nodeType == XML_COMMENT_NODE){
				$lNewParent->appendChild( $lCurrentSibling );//Важно е, че lCurrentSibling вече се мести в новия възел и изчезва от текущия							
			}
			$lCurrentSibling = $pCurrentNode->nextSibling;//Понеже lCurrentSibling вече е в новия възел и е изчезнал от текущия възел
		}
		$pNewNode = $lNewParent;		
		$pCurrentNode = $pCurrentNode->parentNode;
	}
	return $lNewParent;
}

//Връща масив от xpath expression-и, в които ще се търсят брейк тагове за да се сплитнат
function getBreakTagsXpaths(){
	$lResult = array();
	$lCon = Con();
	$lSql = 'SELECT id, xpath, climb_up FROM node_split';
	$lCon->Execute($lSql);
	$lCon->MoveFirst();
	while(!$lCon->eof()){
		$lId = (int) $lCon->mRs['id'];
		$lClimbUp = (int) $lCon->mRs['climb_up'];
		$lXPath = $lCon->mRs['xpath'];
		$lResult[$lId] = array('xpath' => $lXPath, 'climb_up' => $lClimbUp);
		$lCon->MoveNext();
	}
	return $lResult;
}
	
function showNewParent($pRs){
	return showYesNo($pRs['new_parent']);
}

function showIsNeeded($pRs){
	return showYesNo($pRs['is_needed']);
}

function showChangeBefore($pRs){	
	return showYesNo($pRs['change_before']);
}

function showChangeAfter($pRs){	
	return showYesNo($pRs['change_after']);
}

function showAutotagAnnotateShow($pRs){	
	return showYesNo($pRs['autotag_annotate_show']);
}


function yesNoAppendedToXml($pRs){
	return showYesNo($pRs['appended_to_xml_file']);
}

function showYesNo($pParam){
	if((int)$pParam )
		return getstr('global.yes');
	return getstr('global.no');
}

function GetHtmlBallons($pXSLResult){
	$lTaxonNamePattern = '/\{\*\*_(.*)_\*\*\}/';
	$lTaxonDivPattern = '/\{\$\$__\$\$\}/';	
	error_reporting(E_ALL);
	ini_set('display_errors', 'Off');
	if( preg_match_all( $lTaxonNamePattern, $pXSLResult, $lMatch ) ){		
		$lTaxonNames = array();
		$lTaxonNamesParsed = array();
		foreach( $lMatch[1] as $lSingleMatch ){
			$lTaxonNamesParsed = ParseTaxonNameLink($lSingleMatch, 0, 1);
			foreach($lTaxonNamesParsed as $lSingleParsedtaxonName) {
				$lTaxonNames[] = $lSingleParsedtaxonName;
			}
		}
		$lTaxonNames = array_unique( $lTaxonNames );
		$lTaxonDivs = '';
		foreach($lTaxonNames as $lSingleTaxonName){
			$lCurrentTaxonDiv = new csimple(array(
				'templs' => array(
					'G_DEFAULT' => 'article_html.taxonBaloonDiv',
				),
				'cache' => 'article_html_taxon_baloon',
				'cachetimeout' => CACHE_TIMEOUT_LENGTH,
				'taxon_name' => $lSingleTaxonName,
			));
			//~ trigger_error("Exec: " . $lSingleTaxonName , E_USER_NOTICE);
			$lTaxonDivs .= $lCurrentTaxonDiv->DisplayC();
		}
		if (count($lTaxonNames)) {
			$ltmpfile=tempnam('/tmp/', 'TAXONP_');
			//~ $ltmpfile='/tmp/saso.txt';
			if (file_put_contents($ltmpfile, implode("\n", $lTaxonNames))) {
				$cmd="php ".TAXON_PROFILE_CC_SCRPT." ".$ltmpfile." ".'"'.TAXON_PROFILE_CC_BASEURL.'"'." 0 > /dev/null &"; 
				//~ $cmd="php ".TAXON_PROFILE_CC_SCRPT." ".$ltmpfile." ".'"'.TAXON_PROFILE_CC_BASEURL.'"'." 0 > $ltmpfile &"; 
				trigger_error("Exec: " .$cmd , E_USER_NOTICE);
				exec($cmd );
			} else 
				trigger_error("Failed to write toxon names to file: " .$ltmpfile , E_USER_NOTICE); //da se napravi na kvoto triabva
		}
		
		
		$pXSLResult = preg_replace($lTaxonNamePattern, '', $pXSLResult);
		$pXSLResult = preg_replace($lTaxonDivPattern, $lTaxonDivs, $pXSLResult);
	}
	return $pXSLResult;
	
}

function getSingleTaxonBaloon($pTaxonName){
	$lUrl = TAXON_BALOON_SRV . '?taxon_name=' . rawurlencode($pTaxonName);
	return executeExternalQuery($lUrl);
}

function parseTaxonNameForBaloon($pTaxonName){
	return preg_replace('/\.|\s+/i', '_', $pTaxonName);
}

function parseContribName($pFullName, $pReturnFirstName = 1){
	$pFullName = trim($pFullName);
	$lLastSpace = mb_strrpos($pFullName, ' ');
	$lFirstName = $pFullName;
	$lLastName = '';
	if( $lLastSpace !== false ){
		$lFirstName = trim(mb_substr($pFullName, 0, $lLastSpace));
		$lLastName = trim(mb_substr($pFullName, $lLastSpace + 1));
	}
	if( $pReturnFirstName )
		return $lFirstName;
	return $lLastName;
}

function getContribSurname($pFullName){	
	return parseContribName($pFullName, 0);
}

function getContribGivenNames($pFullName){
	return parseContribName($pFullName);
}

function parseContribUriAffNum($pFakeAddrUriText, $pReturnAffNum = 1){
	$pFakeAddrUriText = trim($pFakeAddrUriText);
	$lLastComa = mb_strrpos($pFakeAddrUriText, ',');
	$lAddrNum = '';
	$lUriSym = $pFakeAddrUriText;
	if( $lLastComa !== false ){
		$lAddrNum = trim(mb_substr($pFakeAddrUriText, 0, $lLastComa));
		$lUriSym = trim(mb_substr($pFakeAddrUriText, $lLastComa + 1));
	}
	if( $pReturnAffNum )
		return $lAddrNum;
	return $lUriSym;
	
}

function getContribAffNum($pFakeAddrUriText){
	return parseContribUriAffNum($pFakeAddrUriText);
}

function getContribUriSym($pFakeAddrUriText){
	return parseContribUriAffNum($pFakeAddrUriText, 0);
}

function parseDate($pDate){
	if(!preg_match('/(?P<day>\d{1,2})\s*(?P<month>[a-z]+)\s*(?P<year>\d{2,4})/uims', $pDate, $pMatch))
		return false;
	return $pMatch;
}

function getDateDay($pDate){
	$lResult = parseDate($pDate);
	if( $lResult !== false )
		return $lResult['day'];
	return '';
}

function getDateMonth($pDate){
	$lResult = parseDate($pDate);
	if( $lResult !== false )
		return $lResult['month'];
	return '';
}

function getDateYear($pDate){
	$lResult = parseDate($pDate);
	if( $lResult !== false )
		return $lResult['year'];
	return '';
}

function bhl_showvolume($pVolume) {
	if ($pVolume)
		return $pVolume . ":";
	else
		return '';
}

function bhl_writecomma($pCount, $pCounter){
	if ($pCounter < $pCount)
		return ', ';
	else
		return '';
}

function cb_bhl($pCurl, $pBuf) {//callback funkcia pri chetene na xml-a ot BHL
	global $gBHLData;
	$gBHLData .= $pBuf;
	$lLen = strlen($gBHLData);
	//~ if ($_SERVER['REMOTE_ADDR'] == '193.194.140.198') {
		//~ echo $lLen . "??" . BHL_MAX_READ_LEN;
	//~ }
	if ((int)$lLen > (int)BHL_MAX_READ_LEN) {
		return 0;
	}
	return strlen($pBuf);
}


function bhl_showimage($pTaxonName, $pImgUrl, $pImg, $pNodata) {
	if ($pNodata)
		return '';
	else
		return '<a href="' . ParseTaxonExternalLink($pTaxonName, $pImgUrl) . '"><img border="0" align="right" src="' . $pImg . '"></img></a>';
}

function GetFormattedXml($pXml, $pReplaceBrSymbol = 0){	
	if( $pReplaceBrSymbol ){
		$pXml = str_replace("<" . SPLIT_TAG_NAME . "/>", "\n", $pXml);
		$pXml = str_replace("<" . SPLIT_TAG_NAME . "></" . SPLIT_TAG_NAME . ">", "\n", $pXml);
	}
	return formatXmlString($pXml);
}

function showSpecial($pRs){
	$lSpecial = (int) $pRs['special'];
	switch($lSpecial){
		default:
		case 0: return getstr('admin.indesign_templates_details.specialNo');
		case 1: return getstr('admin.indesign_templates_details.specialTable');
		case 2: return getstr('admin.indesign_templates_details.specialFigure');
	}
}

/** XML FORMAT START - следващите функции реализират форматиране на xml-a */
function formatXmlString($pXml) {
	//~ return $pXml;
	$lDOM = new DOMDocument("1.0");	
	$lDOM->preserveWhiteSpace = true;
	$lDOM->resolveExternals = true;
	if (!$lDOM->loadXML($pXml)){		
		return $pXml;
	}	
	$lXpath  = new  DOMXPath($lDOM);
	$lContent = '';
	$lDeclaredNamespaces = array();
	formatXmlRecursive($lDOM->documentElement, $lContent, $lXpath,  $lDeclaredNamespaces, 0);		
	$lContent = '<?xml version="' . $lDOM->version . '"?>' . parseXmlDoctype($lDOM->doctype) . $lContent;
	return $lContent;
}

function parseXmlDoctype(&$pDoctype){
	if( $pDoctype ){
		return $pDoctype->internalSubset;
	}
	return '';
}

function formatXmlRecursive(&$pCurrentElement, &$pContent, &$pXPath, &$pDeclaredNamespaces, $pDepth = 0, $pFormatXml = 1){
	/**
		Ако $pFormatXml е 0 не форматираме - не слагаме нови редове и форматиращи символи. Това се случва само при определени тагове - p, title ...
	*/
	$lFormatXml = $pFormatXml;
	if( in_array($pCurrentElement->nodeType, array(1, 8))){//Element ili comment		
		$lPreviousSibling = $pCurrentElement->previousSibling;
		while( $lPreviousSibling && !in_array($lPreviousSibling->nodeType, array(1, 3, 8) )){//Otivame do predniq sibling koito e tekst, comment ili element
			$lPreviousSibling = $lPreviousSibling->previousSibling;
		}
		
		$lPrevSiblingData = CheckPreviousSibling($lPreviousSibling, $pDepth);				
		
		
		$lHasElementChildren = false;
		$lLastTextChild = false;
		
		if( $lFormatXml )//За да може да го спрем рекурсивно ако веднъж е станало 0
			$lFormatXml = !CheckIfNodeIsNotToBeFormatted($pCurrentElement);
		
		$lTagStart = GetElementOpenTag($pCurrentElement, $pXPath, &$pDeclaredNamespaces);	
		if( $pCurrentElement->nodeType == 1 ){//Element				
			$lChildren = $pCurrentElement->childNodes;
			$lTagContent = '';
			for($i = 0; $i < $lChildren->length; $i++){				
				$lChild = $lChildren->item($i);
				
				if( !in_array($lChild->nodeType, array(1, 3, 8) )){
					continue;
				}
				if( $lChild->nodeType == 1 ){
					$lHasElementChildren = true;
					$lLastTextChild = null;//Za da slagame nov red ako posledniq tekstov child e predi element child
				}elseif( $lChild->nodeType == 3){
					$lLastTextChild = $lChild;
				}
				formatXmlRecursive($lChild, $lTagContent, $pXPath, &$pDeclaredNamespaces, $pDepth + 1, $lFormatXml);
			}
		}else{//Comment
			$lTagContent = EscapeTextContent($pCurrentElement->nodeValue);
		}
		
		$lTagEnd = GetElementCloseTag($pCurrentElement);
		if( !CheckForEmptyFormattingTag($pCurrentElement, $lHasElementChildren) ){
			//Обработваме само неформатиращите тагове + форматиращите тагове, които не съдържат само whitespace-ове
			
			if( $pFormatXml ){//Гледаме дали трябва да форматираме xml-a
				FormatWithPrefixString($pContent, $lPrevSiblingData[0], $lPrevSiblingData[1]);
			}
			$pContent .= $lTagStart;
			$pContent .= $lTagContent;
			if( $lHasElementChildren && $pFormatXml ){
				$lLastTextChildData = CheckPreviousSibling($lLastTextChild, $pDepth);		
				FormatWithPrefixString($pContent, $lLastTextChildData[0], $lLastTextChildData[1]);			
			}
			$pContent .= $lTagEnd;
		}
		
	}elseif( $pCurrentElement->nodeType == 3){//Text
		$pContent .= EscapeTextContent($pCurrentElement->textContent);
	}
}

function CheckIfNodeIsNotToBeFormatted(&$pCurrentNode){
	/** Връща true, ако децата на текущия node не трябва да се форматират. Връща false в противен случай
	*/	
	if( $pCurrentNode->nodeType != 1 )
		return false;	
	$lNodesNotToBeFormatted = array('p', 'title', 'label', 'tp:nomenclature-citation', 'ref', 'caption', 'th', 'td', 'kwd');
	if( !in_array( mb_strtolower($pCurrentNode->nodeName), $lNodesNotToBeFormatted ) )
		return false;	
	return true;
}

function CheckForEmptyFormattingTag(&$pCurrentNode, $pHasElementChildren){
	/**
		Връща true, ако възела е форматиращ(болд, италик ...) и съдържанието му е само от whitespace-ове и няма element деца.
		В противен случай връща false;
	*/
	
	if( $pCurrentNode->nodeType != 1 )
		return false;
	if( $pHasElementChildren )
		return false;
	$lFormattingTagsArr = array('underline', 'italic', 'bold', 'p');
	if( !in_array( mb_strtolower($pCurrentNode->nodeName), $lFormattingTagsArr ) )
		return false;
	$lNonWhiteSpacePattern = '/\S/u';
	
	//~ if( preg_match($lNonWhiteSpacePattern, $pCurrentNode->textContent, $lMatch) ){//съдържанието не е само whitespace-ове
	//~ if( trim($pCurrentNode->textContent) ){
		//~ var_dump(trim($pCurrentNode->textContent));
	//~ }
	if( preg_match($lNonWhiteSpacePattern, $pCurrentNode->textContent, $lMatch) ){//съдържанието не е само whitespace-ове		
		return false;
	}	
	return true;
}

function EscapeTextContent($pText){
	return htmlspecialchars($pText);
}

function CalculateNodeFormattingSymbols($pDepth){
	/**
		Връща броя на форматиращите символи, които съответстват на съответната дълбочина
	*/
	return XML_FORMATTING_SYMBOL_PER_LEVEL * $pDepth;
}

function CheckPreviousSibling($pPreviousSibling, $pDepth){
	/**	Opredelq s kolko simvola trqbva da se podravni faila.
		Ako predhojdashtiq go element e tekstov node koito zavyrshva na \n i formatirashti simvoli - proqt na tezi koito trqbva da se dobavqt
		namalqva. Ako formatirashtite simvoli sa prekaleno mnogo - trqbva da se reje ot teksta.
	*/
	$lPutNewline = true;
	$lPutFormattingSymbols = CalculateNodeFormattingSymbols($pDepth);
	if( !$pPreviousSibling || $pPreviousSibling->nodeType != 3 ){
		return array($lPutNewline, $lPutFormattingSymbols);
	}
	$lText = $pPreviousSibling->textContent;
	$lLastNewLinePos = mb_strrpos($lText, "\n");
	if( $lLastNewLinePos === false ){
		return array($lPutNewline, $lPutFormattingSymbols);
	}	
	$lFollowingText = mb_substr($lText, $lLastNewLinePos + 1);
	$lFollowingLength = mb_strlen($lFollowingText);
	for( $i = 0; $i < $lFollowingLength; ++$i ){		
		if( $lFollowingText[$i] !== XML_FORMATTING_SYMBOL ){
			//~ echo 111;
			//~ var_dump($lFollowingText[$i]);
			//~ var_dump(XML_FORMATTING_SYMBOL);
			//~ var_dump($lFollowingText[$i] === ' ');
			//~ exit;
			return array($lPutNewline, $lPutFormattingSymbols);
		}
	}	
	
	return array(false, $lPutFormattingSymbols - $lFollowingLength);
}

function FormatWithPrefixString( &$pContent, $pPutNewLine, $pFormattingSymbolsCount ){
	/**	Formatira stringa. $pPutNewLine opredelq dali she se slaga nov red, a $pFormattingSymbolsCount - broq na simvolite,
		koito shte se dobavqt/iztriqt.
	*/
	if( $pPutNewLine ){
		$pContent .= "\n";
	}
	//~ var_dump($lPutFormattingSymbols);
	if( $pFormattingSymbolsCount < 0 ){//Ako trqbva da rejem simvoli ot teksta
		$pContent = mb_substr($pContent, 0, $pFormattingSymbolsCount); 
	}else{//Ako trqbva da dobavqme simvoli 
		for( $i = 0; $i < $pFormattingSymbolsCount; ++$i)
			$pContent .= XML_FORMATTING_SYMBOL;
	}
}

function GetElementOpenTag(&$pCurrentElement, &$pXPath, &$pDeclaredNamespaces){
	/**
		Връща текста на отварящият таг за текущия node. В него се съдържат и атрубутите и декларираните namespace-ове.
	*/
	if( $pCurrentElement->nodeType == 8 ){//Comment
		return '<!--';
	}
	$lResult = '<';
	//~ if( $pCurrentElement->prefix ){
		//~ $lResult .= $pCurrentElement->prefix . ':';
	//~ }
	$lResult .= $pCurrentElement->nodeName;
	$lAttributes = $pCurrentElement->attributes;		
	for( $i = 0; $i < $lAttributes->length; ++$i){
		
		$lResult .= ' ';
		$lSingleAttribute = $lAttributes->item($i);	
		
		$lResult .= $lSingleAttribute->nodeName . '="' . $lSingleAttribute->nodeValue . '"';
	}	
	//Dobavqme i namespace-ovete
	$lNameSpaceXpath = './namespace::*';		
	$lXpathResult = $pXPath->query($lNameSpaceXpath, $pCurrentElement);
	for( $i = 0; $i < $lXpathResult->length; ++$i){
		$lNameSpace = $lXpathResult->item($i);		
		if( !array_key_exists($lNameSpace->nodeName, $pDeclaredNamespaces) || $pDeclaredNamespaces[$lNameSpace->nodeName] != $lNameSpace->nodeValue){//Ako imame nov namespace
			$lResult .= ' ';
			$lResult .= $lNameSpace->nodeName . '="' . $lNameSpace->nodeValue . '"';		
			$pDeclaredNamespaces[$lNameSpace->nodeName] = $lNameSpace->nodeValue;
		}
	}	
	$lResult .= '>';
	return $lResult;
}

function GetElementCloseTag(&$pCurrentElement){
	if( $pCurrentElement->nodeType == 8 ){//Comment
		return '-->';
	}	
	return '</' . $pCurrentElement->nodeName . '>';
}

function SerializeAjaxOutput($pObject){
	$pObject->GetDataC();
	$lResult = $pObject->Display();
	$lResultArray = array(
		'result' => $lResult,
		'rescnt' => (int) $pObject->GetResultCount(),
		'req_objects' => $pObject->m_AjaxRequiredObjectIds,
		'got_data_from_cache' => (int)$pObject->m_got_data_from_cache,
	);
	echo json_encode($lResultArray);
}

/** XML FORMAT END */

function SaveArticleXml($pArticleId, $pXml){
	global $user;
	if( !$pArticleId )
		return;
	$lCon = Con();
	
	$lXml = GetFormattedXml($pXml);
	$lSql = 'SELECT * FROM spArticle(1, ' . (int) $pArticleId. ', \'' . q($lXml) . '\', ' . (int) $user->id . ')';
	$lCon->Execute($lSql);
	$lCon->MoveFirst();
	if( !$lCon->Eof()){
		SyncXmlData($lArticleId, $lXml);
		return (int)$lCon->mRs['id'];			
	}
}

function GetArticleXml($pArticleId){
	$lCon = Con();
	$lSql = 'SELECT * FROM spArticle(0, ' . (int) $pArticleId. ', null, null)';
	$lCon->Execute($lSql);
	$lCon->MoveFirst();
	if( !$lCon->Eof()){
		return $lCon->mRs['xml'];
	}
}

function displayMenuLink($pResultsExist){
	if($pResultsExist) 
		return;
	return ' class="inactiveMenuLink" title="' . getstr('admin.articles.menuLinkDoesNotExist') . '" ';
}

function getArticlePicId($pArticleId, $pImgName){
	$lCon = Con();
	$lSql = 'SELECT p.guid FROM
		photos p
		JOIN storyproperties sp ON sp.valint = p.guid AND sp.propid = ' . (int) ARTICLE_PHOTOS_PROPID . '
		JOIN articles a ON a.id = sp.guid
		WHERE a.id = ' . (int) $pArticleId . ' AND p.filenameupl = \'' . q($pImgName) . '\' LIMIT 1';
	$lCon->Execute($lSql);
	$lCon->MoveFirst();
	return (int)$lCon->mRs['guid'];
}

function AddPhotoToArticle($pArticleId, $pPicId){
	if((int) $pArticleId && (int) $pPicId){
		$lCon = Con();
		$lSql = 'SELECT * FROM spAddPhotoToArticle(' . (int) $pArticleId . ', ' . (int) $pPicId . ', ' . (int) ARTICLE_PHOTOS_PROPID .')';
		$lCon->Execute($lSql);
	}
}

function UploadPic($pName, $pDir, $pPicId, &$pError) {
	$gMaxSize = 100*1024*1024; // 100 MB	
	//~ $gMaxSize = 500 // Za testove;
	$extarray = array(".jpeg", ".jpg", ".gif", ".tif", ".tiff", ".bmp", ".png");
	$typearr = array("image/pjpeg", "image/jpeg", "image/gif", "image/tiff", "image/png", "image/bmp");
	$imgUploadErr = 1;
	$lPicId = 0;
	
	$lCn = Con() ;
	if ( $_FILES[$pName]['name'] ) {
		
		$pFnUpl = $_FILES[$pName]['name'];
		$pTitle = $pFnUpl;
		
		$gFileExt = substr($_FILES[$pName]['name'], strrpos($_FILES[$pName]['name'], '.'));
		$isImageExtension = in_array(strtolower($gFileExt), $extarray);
		$isImageMime = in_array(strtolower($_FILES[$pName]['type']), $typearr);
		
		if ($isImageExtension && $isImageMime) {
			if ($_FILES[$pName]['size'] > $gMaxSize) {
				$pError = getstr('admin.articles.error_picTooBigMaxSize')  . ($gMaxSize / (1024 * 1024)). ' MB';
			} elseif (!$_FILES[$pName]["size"]) {
				$pError = getstr('admin.articles.error_wrongFile');
			} elseif ($_FILES[$pName]['error'] == UPLOAD_ERR_OK) {				
				if( !$lCn->Execute('SELECT PicsUpload(1, ' . (int) $pPicId. ', 0,\'' . q($pTitle) . '\', \'' . q($pFnUpl) . '\', \'' . q($PicText) . '\') as picid') ){
					$lCn->MoveFirst();
					$lPicId = (int)$lCn->mRs['picid'];

					if ($lPicId) {
						if (!move_uploaded_file($_FILES[$pName]['tmp_name'], $pDir . $lPicId . $gFileExt)) {
							$pError = getstr('admin.articles.error_error') . $_FILES[$pName]['error'];
						} else { 
							// Vsichko e ok... pravim jpg i mahame originala
							DeletePicFiles( $lPicId );
							exec(escapeshellcmd("convert -colorspace rgb -quality 80 " . $pDir . $lPicId . $gFileExt . " " . $pDir . 'oo_' . $lPicId . '.jpg' ));
							exec("convert -colorspace rgb -quality 80 -thumbnail " . escapeshellarg('1024x1024>') . " " . $pDir . $lPicId . $gFileExt . " " . $pDir . 'big_' . $lPicId . '.jpg' );
							unlink($pDir . $lPicId . $gFileExt);
							$imgUploadErr = 0;
						}
					} else {
						$pError = getstr('admin.articles.error_dbError');
					}
				}else{
					$pError = $lCn->mErrMsg ? $lCn->mErrMsg : getstr('admin.articles.error_dbError');
				}
			} else {
				$pError = getstr('admin.articles.error_errorWhileSavingFile');
			}
		} else {
			$pError = getstr('admin.articles.error_wrongFileFormatAllowedFormatsAre') . implode(' ', $extarray);
		}
	} else {
		$pError = getstr('admin.articles.error_noFileUploaded');
	}
	
	if (!$imgUploadErr) 
		return $lPicId;
	
	if ($lPicId) //Mahame snimkata pri greshka
		$lCn->Execute('SELECT PicsUpload(3, ' . (int)$lPicId . ', null, null, null, null);');
	return false;
}

function DeletePic($pPicId){
	$lCn = Con();
	$lCn->Execute('SELECT PicsUpload(3, ' . (int)$pPicId . ', null, null, null, null);');
	$lCn->Execute('SELECT spDeletePicFromArticles('. (int) $pPicId . ', ' . (int) ARTICLE_PHOTOS_PROPID . ')');
	DeletePicFiles($pPicId);
}

function DeletePicFiles($pPicId){
	if( !$pPicId )
		return;
	$lFormats = array('gif', 'jpg');
	foreach($lFormats as $lFormat){
		$lPrefixes = array('oo', 'big', 'gb', 's', 'mx50', 'm80', 'd200x150');
		foreach( $lPrefixes as $lPrefix){
			$lFile = PATH_DL . $lPrefix . '_' . $pPicId . '.' . $lFormat;
			if( file_exists($lFile) )
				unlink($lFile);
		}
	}
}

function DeleteArticlePics($pArticleId){
	if((int) $pArticleId ){
		$lCon = Con();
		$lSql = 'SELECT p.guid
		FROM photos p
		JOIN storyproperties sp ON sp.valint = p.guid AND sp.propid = ' . (int) ARTICLE_PHOTOS_PROPID . '
		JOIN articles s ON s.id = sp.guid
		WHERE s.id = ' . $pArticleId;
		$lCon->Execute($lSql);
		$lCon->MoveFirst();
		$lPictures = array();
		while( !$lCon->Eof()){
			$lPictures[] = (int) $lCon->mRs['guid'];			
			$lCon->MoveNext();
		}
		foreach( $lPictures as $lPicId ){
			if((int) $lPicId )
				DeletePic( $lPicId );
		}
	}
}

//Poneje ne e na nash syrvyr ne sa pozvoleni exec i system i polzvame perl script koito execva komandite
function executeConsoleCommand($pCommand, $pArgs, $pUsePassThru = 1){	
	if( !is_array($pArgs))
		$pArgs = array();
	/**
		Масив с кодовете на операциите
	*/
	if( (int) USE_PERL_EXECS ){
		$lCommandsArr = array(
			1 => 'convert',
		);
		$lPerlPhpAddress = PERL_EXEC_ADDRESS;
		
		$lCommandFound = false;
		$gCommandCode = -1;
		foreach( $lCommandsArr as $lCommandCode => $lCommandName ){
			if( $lCommandName == $pCommand ){
				$lCommandFound = true;
				$gCommandCode = $lCommandCode;
			}
		}
		if( !$lCommandFound )
			return;
		
		$lUrl = $lPerlPhpAddress . '?command=' . $gCommandCode . '&argsCount=' . (int) count($pArgs);
		
		$lArgIter = 1;
		foreach( $pArgs as $lCommandArgument ){
			$lUrl .= '&arg' . $lArgIter . '=' . rawurlencode($lCommandArgument);
			$lArgIter++;
		}
		//~ var_dump(file_get_contents($lUrl));
		return file_get_contents($lUrl);
	}else{
		$lCommandToExecute = $pCommand;
		foreach( $pArgs as $lCommandArgument ){
			$lCommandToExecute .= ' ' .$lCommandArgument;
		}		
		if( $pUsePassThru ){
			ob_start();			
			passthru($lCommandToExecute);
			$lContent = ob_get_contents();
			ob_clean();
			return $lContent;
		}else{
			exec($lCommandToExecute);
		}
	}
}

//Izkarva taxonite sys specialnite poleta ot xml-a za eol i dava link za redaktiraneto im
function GetEolExportTaxons($pExportId, $pXml){
	$lTempls = array(
		G_ROWTEMPL => 'eol_export.taxonRow',
		G_HEADER => 'eol_export.taxonHead',
		G_STARTRS => 'eol_export.taxonStart',
		G_ENDRS => 'eol_export.taxonEnd',
		G_FOOTER => 'eol_export.taxonFoot',
		G_NODATA => 'eol_export.taxonNoData',
		G_ERR_ROW => 'eol_export.taxonErrRow',
	);
	
	$lJournalInfoSql = '
		SELECT j.pensoft_title, e.issue_id 
		FROM eol_export e
		JOIN journals j ON j.id = e.journal_id
		WHERE e.id = ' . (int) $pExportId;	
	$lCon = Con();
	$lCon->Execute($lJournalInfoSql);
	$lCon->MoveFirst();
	if( !$lCon->Eof()){
		$lJournalTitle = $lCon->mRs['pensoft_title'];
		$lIssueId = (int)$lCon->mRs['issue_id'];
	}
	$lObject = new crs_xml(array(
		'xml' => $pXml,
		'templs' => $lTempls,
		'row_select_xpath_query' => '//def:taxon',
		'register_xpath_namespaces' => array(
			'xsd' => 'http://www.w3.org/2001/XMLSchema',
			'dc' => 'http://purl.org/dc/elements/1.1/',
			'dwc' => 'http://rs.tdwg.org/dwc/dwcore/',
			'def' => 'http://www.eol.org/transfer/content/0.3',
		),
		'export_id' => $pExportId,
		'issue_id' => $lIssueId,
		'journal_title' => $lJournalTitle,
		'row_fields_query' => array(
			'identifier' => array(
				'xpath' => './dc:identifier',								
			),
			'kingdom' => array(
				'xpath' => './dwc:Kingdom',
			),			
			'family' => array(
				'xpath' => './dwc:Family',				
			),
			'scientificName' => array(
				'xpath' => './dwc:ScientificName'
			),
			'fig_count' => array(
				'xpath' => 'count(./def:dataObject[def:dataType=\'http://purl.org/dc/dcmitype/StillImage\'])',				
				'evaluate' => true,
			),
			'desc_count' => array(
				'xpath' => 'count(./def:dataObject[dc:title=\'Description\'])',				
				'evaluate' => true,
			),
			'dist_count' => array(
				'xpath' => 'count(./def:dataObject[dc:title=\'Distribution\'])',				
				'evaluate' => true,
			),
		),
	));	
	return $lObject->Display();
}

/**
	Синхронизира полетата от експорта с kfor-а.
	Ако pWriteFields е false тогава стойносттите на полетата се слагат в kfor-а иначе се записват от kfor-а във xml-a.
	pDataArray - Ако вместо един таксон(kfor) искаме да ъпдейтнем/вземем стойността на няколко таксона подаваме масив със следния формат
		doi_identifier => масив от полетата на съответния таксон със следния формат
			име–на–поле => стойност
		
		
*/
function SyncEolExportFields($pKfor, $pWriteFields = false, &$pDataArray = false){
	$lCon = Con();
	$lCon->Execute('SELECT xml FROM eol_export WHERE id = ' . (int) $pKfor->lFieldArr['export_id']['CurValue']);
	$lCon->MoveFirst();
	if( $lCon->Eof() ){//Ako ne syshtestvuva exporta
		$pKfor->SetError('export_id', getstr('admin.eol_export.noSuchExport') );
	}else{//Ima takava statiq
		$lXml = $lCon->mRs['xml'];
		$pKfor->lFieldArr['xml']['CurValue'] = $lXml;
		$lXmlDocument = new DOMDocument("1.0");
		$lXmlDocument->resolveExternals = true;		
		if( !$lXmlDocument->loadXML($lXml)){//Ako xml-a e greshen
			$pKfor->SetError('export_id', getstr('admin.eol_export.wrongExportXml') );			
		}else{//XML-a e OK
			$lXPath = new DOMXPath($lXmlDocument);
			$lNamespaces = array(
				'xsd' => 'http://www.w3.org/2001/XMLSchema',
				'dc' => 'http://purl.org/dc/elements/1.1/',
				'dwc' => 'http://rs.tdwg.org/dwc/dwcore/',
				'def' => 'http://www.eol.org/transfer/content/0.3',
			);//Namespace-ove za xpatha
			foreach($lNamespaces as $lNamespaceName => $lNamespaceUrl){
				$lXPath->registerNamespace($lNamespaceName, $lNamespaceUrl);
			}
			
			
			
			/**
				Масив с полетата. Форматът е:
					име на полето => масив с информация за полето
						Форматът на масива е 
							xpath -> xpath query за намиране на възела в него
							write_to_xml => true/false определя дали да го пишем в xml-a
							namespace_uri => адреса на ns-a на възела. Ползва се при създаване на нов възел
							qualified_name => qualified name на възела. Ползва се при създаване на нов възел
							following_elements_xpath => масив от xpath query-та на възли, които са след него 
								Поонеже ако трябва да създаваме възела във xml-а трябва да знаем къде точно да го създадем
			*/
			$lFieldsExpressions = array(
				'kingdom' => array(
					'xpath' => './dwc:Kingdom',
					'write_to_xml' => true,
					'namespace_uri' => $lNamespaces['dwc'],
					'qualified_name' => 'Kingdom',
					'following_elements_xpath' => array(
						'./dwc:Phylum',
						'./dwc:Class',
						'./dwc:Order',
						'./dwc:Family',
						'./dwc:Genus',
						'./dwc:ScientificName',
						'./def:rank',
						'./def:commonName',
						'./def:synonym',
						'./def:agent',
						'./dcterms:created',
						'./dcterms:modified',
						'./reference',
						'./def:additionalInformation',
						'./def:dataObject',
						
					),
				),					
				'family' => array(
					'xpath' => './dwc:Family',
					'namespace_uri' => $lNamespaces['dwc'],
					'qualified_name' => 'Family',
					'write_to_xml' => true,
					'following_elements_xpath' => array(
						'./dwc:Genus',
						'./dwc:ScientificName',
						'./def:rank',
						'./def:commonName',
						'./def:synonym',
						'./def:agent',
						'./dcterms:created',
						'./dcterms:modified',
						'./reference',
						'./def:additionalInformation',
						'./def:dataObject',
						
					),
				),
				'scientific_name' => array(
					'xpath' => './dwc:ScientificName',
					'write_to_xml' => false,
					'namespace_uri' => $lNamespaces['dwc'],
					'qualified_name' => 'ScientificName',
					'following_elements_xpath' => array(
						'./def:rank',
						'./def:commonName',
						'./def:synonym',
						'./def:agent',
						'./dcterms:created',
						'./dcterms:modified',
						'./reference',
						'./def:additionalInformation',
						'./def:dataObject',
						
					),
				),
			);
			/**
				За да уеднаквим нещата правим така че ако работим само с kfor-a на практика пак да работим с масив
				lUseKfor - за да може после да ъпдейтнем полетата на kfor-a ако правим четене
			*/
			$lUseKfor = false;
			if( !is_array($pDataArray) || !count($pDataArray)){//Rabotim s kfora
				$pDataArray = array();
				$lUseKfor = true;
				$lDoi = $pKfor->lFieldArr['doi']['CurValue'];
				$pDataArray[$lDoi] = array();
				foreach($lFieldsExpressions as $lFieldName => $lFieldArr ){
					$pDataArray[$lDoi][$lFieldName] = $pKfor->lFieldArr[$lFieldName]['CurValue'];
				}
			}
			
			//Обикаляме всички таксони
			foreach($pDataArray as $lDoiNum => &$lTaxonFields){
				
				
				
				$lTaxonXpath = '//def:taxon[dc:identifier=\'' . $lDoiNum . '\']';
				$lTaxonResult = $lXPath->query($lTaxonXpath);
				
				
				if( !$lTaxonResult->length ){//Ako nqma takyv takson
					$pKfor->SetError('export_id', getstr('admin.eol_export.noTaxonWithDoi') . ' ' . $lDoiNum);
					break;
				}else{//Syshtestvuva si taksona
					$lTaxonNode = $lTaxonResult->item(0);
					//Populvame poletata				
					
					foreach($lFieldsExpressions as $lFieldName => $lFieldInfoArr){
						if( $pWriteFields && !$lFieldInfoArr['write_to_xml'] )//Ako vyzela ne trqbva da se update-wa - prodyljavame
							continue;
							
						$lFieldXPath = $lFieldInfoArr['xpath'];
						$lFieldResult = $lXPath->query($lFieldXPath, $lTaxonNode);
						if( $lFieldResult->length ){//Ako node-a systestvuva
							if( !$pWriteFields ){//Vzimame stoinostta
								$lTaxonFields[$lFieldName] = $lFieldResult->item(0)->textContent;
							}else{//Pishem po xml-a							
								$lFieldResult->item(0)->nodeValue = $lTaxonFields[$lFieldName];							
							}
						}elseif($pWriteFields){//Ako node-a ne syshtestvuva i pishem po xml-a trqbva da go syzdadem
							/**
								Обикаляме xpath-овете на следващите го елементи и ако намерим такъв елемент
								слагаме новия елемент преди намерения. Ако не сме намерили нищо го слагаме като последен
							*/
							$lFollowingElementsXpaths = $lFieldInfoArr['following_elements_xpath'];
							$lFollowingNode = false;
							foreach($lFollowingElementsXpaths as $lXpath){							
								$lFollowingNodeResult = $lXPath->query($lXpath, $lTaxonNode);
								if( $lFollowingNodeResult->length ){
									$lFollowingNode = $lFollowingNodeResult->item(0);
									break;
								}
							}
							
							$lNodeNsUri = $lFieldInfoArr['namespace_uri'];
							$lQualifiedName = $lFieldInfoArr['qualified_name'];
							$lNewNode = $lXmlDocument->CreateElementNS($lNodeNsUri, $lQualifiedName, $lTaxonFields[$lFieldName]);
							
							if( $lFollowingNodeResult === false ){//Ako ne e nameren sledvasht vyzel - appendvame
								$lTaxonNode->appendChild($lNewNode);
							}else{//Nameren e sledvasht vyzel - insertvame predi nego
								$lTaxonNode->insertBefore($lNewNode, $lFollowingNode);
							}
						}
					}
					
				}
				if($lUseKfor && !$pWriteFields){//Ako trqbva da popylnim kfor-a
					foreach($lTaxonFields as $lFieldName => $lValue ){
						$pKfor->lFieldArr[$lFieldName]['CurValue'] = $lValue;
					}
				}
			}
			
			if( $pWriteFields && !$pKfor->lErrorCount ){//Zapazvame xml-a v bazata				
				$lCon->Execute('UPDATE eol_export SET xml = \'' . q( $lXmlDocument->SaveXML() ) . '\' WHERE id = ' . (int) $pKfor->lFieldArr['export_id']['CurValue']);
				//~ echo '<pre>' . $lXmlDocument->SaveXML() . '</pre>';
			}
			
			
		}
		
	}
	
}
/**
	Взима xml-ите на статиите за дадено издание и брой и ги сглабя в общ xml. След това му пуска xsl трансформацията за eol_export-а и го запазва в базата
*/
function GetPensoftJournalXmls($pKfor){
	$lJournalId = (int)$pKfor->lFieldArr['journal_id']['CurValue'];
	$lIssueId = (int)$pKfor->lFieldArr['issue_id']['CurValue'];
	$lExportId = (int)$pKfor->lFieldArr['id']['CurValue'];
	try{
		$lXml = GetPensoftJournalIssueXmls($lJournalId, $lIssueId);
		$lXml = transformXmlWithXsl($lXml, PATH_CLASSES . 'xsl/eol_export_new.xsl');
		$lXml = GetFormattedXml($lXml);
		$pKfor->lFieldArr['xml']['CurValue'] = $lXml;
	}catch(Exception $lException){
		$pKfor->SetError('generate_xml', $lException->getMessage() );			
	}
}

/**
	Взима xml-ите на статиите за дадено издание и брой и ги сглабя в общ xml.
	Ако е сетната глобалната променлива BACKUP_PENSOFT_JOURNAL_XMLS - xml-a със списъка със статиите и xml-ите на отделните статии се запазват, ако са необходими при бъдещи справки
*/
function GetPensoftJournalIssueXmls($pJournalId, $pIssueId){
	$lCon = Con();
	$lCon->Execute('SELECT pensoft_title, pensoft_id FROM journals WHERE id = ' . (int)$pJournalId);
	$lCon->MoveFirst();
	if( $lCon->Eof() ){
		throw new Exception(getstr('admin.journals.noSuchJournal'));
	}
	if( !(int) $pIssueId ){
		throw new Exception(getstr('admin.eol_export.youHaveToEnterAnIssue'));
	}
	
	$lJournalTitle = $lCon->mRs['pensoft_title'];
	$lJournalPensoftId = (int)$lCon->mRs['pensoft_id'];
	$lIssueExportUrl = PENSOFT_ISSUE_EXPORT_URL . '?title=' . rawurlencode($lJournalTitle) . '&volume=' . (int)$pIssueId;
	
	$lResult = executeExternalQuery($lIssueExportUrl);
	
	if( $lResult === false ){
		throw new Exception(getstr('admin.eol_export.couldNotGetIssueExportXml'));
	}
	if( (int)BACKUP_PENSOFT_JOURNAL_XMLS){//Пазим xml-a със списъка на статиите
		$lBackupName = PATH_XML . $lJournalTitle . '_' . $pIssueId . '_list_' . date('d-m-Y H:i:s') . '.xml';
		file_put_contents($lBackupName, $lResult);
	}
	
	/**
		В този domDocument ще строим резултатния xml.
	*/
	$lXmlDocument = new DOMDocument("1.0");
	$lXmlDocument->resolveExternals = true;	
	
	/**
		Слагаме общия таг, който ще държи всички статии
	*/
	$lXmlDocument->appendChild($lXmlDocument->CreateElement('fake_root'));
	
	$lTempXmlDocument = new DOMDocument("1.0");
	$lTempXmlDocument->resolveExternals = true;		
	
	if( !$lTempXmlDocument->loadXML($lResult)){//Ako xml-a e greshen
		throw new Exception(getstr('admin.eol_export.issueExportXmlWrongXml'));
	}
	$lXPath = new DOMXPath($lTempXmlDocument);
	$lArticleXmlUrlXPathQuery = '/journal/articles/article/xml_link|/journal/articles/article/abstract';
	$lArticleXmlUrlXPathResult = $lXPath->query($lArticleXmlUrlXPathQuery);
	/**
		В този масив ще пазим линковете към xml-ите на статиите. Форматът е:
			ид на статия => линк към xml-а за съответната статиия
	*/
	$lArticleXmlUrls = array();
	
	for($i = 0; $i < $lArticleXmlUrlXPathResult->length; ++$i){
		$lArticleId = $lArticleXmlUrlXPathResult->item($i)->parentNode->getAttribute('id');	
		$lLinkType =  $lArticleXmlUrlXPathResult->item($i)->nodeName;	
		$lArticleXmlUrls[$lArticleId][$lLinkType] = htmlspecialchars_decode($lArticleXmlUrlXPathResult->item($i)->nodeValue);//Vryshtame specialnite simvoli - napr. &
	}
	
	foreach($lArticleXmlUrls as $lArticleId => $lLinkArr ){		
		$lXmlUrl = $lLinkArr['xml_link'];
		$lAbstractUrl = $lLinkArr['abstract'];
		$lResult = executeExternalQuery($lXmlUrl);
		
		if( $lResult === false ){
			throw new Exception(getstr('admin.eol_export.couldNotGetIssueArticleXml'));
		}
		
		if( (int)BACKUP_PENSOFT_JOURNAL_XMLS){//Пазим xml-a на статията
			$lBackupName = PATH_XML . $lJournalTitle . '_' . $pIssueId . '_' . $lArticleId . '_' . date('d-m-Y H:i:s') . '.xml';
			file_put_contents($lBackupName, $lResult);
		}
		
		if( !$lTempXmlDocument->loadXML($lResult)){//Ako xml-a e greshen
			throw new Exception(getstr('admin.eol_export.issueArticleXmlWrongXml'));
		}
		
		$lTempXmlDocument->documentElement->SetAttribute('id', $lArticleId);
		$lTempXmlDocument->documentElement->SetAttribute('journal_id', $lJournalPensoftId);
		$lTempXmlDocument->documentElement->SetAttribute('abstract_link', $lAbstractUrl);
		
		$lNewNode = $lXmlDocument->importNode($lTempXmlDocument->documentElement, true);//Копираме xml-a на статията
		$lXmlDocument->documentElement->appendChild($lNewNode);
	}
	//~ throw new Exception(getstr('admin.eol_export.issueArticleXmlWrongXml'));
	return $lXmlDocument->saveXML();
	
}

/**
	Прилага xsl трансформация в/у xml-a
		pXSL - име на файла за xsl-a
		pXML - стринг, който съдържа xml-a
*/
function transformXmlWithXsl($pXML, $pXSL){
	$lXML = new DOMDocument("1.0");
	$lXSL = new DOMDocument("1.0");
	
	
	if (!$lXSL->load($pXSL)) {
		throw new Exception(getstr('admin.articles.xslNotValid'));		
		return;
	}
	
	
	
	$lXML->resolveExternals = true;
	if (!$lXML->loadXML($pXML)) {
		throw new Exception(getstr('admin.articles.xmlNotValid'));		
		return;
	}
	// Configure the transformer
	$lXslProcessor = new XSLTProcessor;	
	$lXslProcessor->registerPHPFunctions();	
	$lXslProcessor->importStyleSheet($lXSL); 
	
	$lXSLResult =  $lXslProcessor->transformToXML($lXML);
	
	return $lXSLResult;
}

/**
	Тази функция се ползва в xsl-a, понеже от doi номера трябва да се махнат първите 8 символа напр.:
		10.3897/zookeys.67.700 => zookeys.67.700
*/
function parseArticleDoi($pDoi){
	return mb_substr($pDoi, 8);
}
/**
	Тази функция се ползва в xsl-a, понеже трябва да се взима само първата буква от дадено име
		10.3897/zookeys.67.700 => zookeys.67.700
*/
function getNameFirstLetter($pName){
	return mb_substr($pName, 0, 1);
}

/**
	Тази функция се ползва в xsl-a, понеже трябва да се конструира пътя до картинката
		$pPicBaseUrl - шаблон за името на картинката като в него параметрите са във формат {име–на–параметър} и трябва да се replace-нат
*/
function getFigPicUrl($pPicBaseUrl, $pJournalId, $pArticleId, $pFileName){
	$pFileName = basename($pFileName);
	$lPatterns = array(
		'{journal_id}' => (int) $pJournalId,
		'{article_id}' => (int) $pArticleId,
		'{file_name}' => $pFileName
	);
	$lPicUrl = $pPicBaseUrl;
	foreach($lPatterns as $lSearch => $lReplacement){
		$lPicUrl = str_replace($lSearch, $lReplacement, $lPicUrl);
	}
	return $lPicUrl;
}

/**
	Вика функцията GetEolExportXmlTaxonExternalInfo за xml-a на подадения kfor и следи за грешки	
*/
function GetEolExportXmlTaxonExternalInfoByKfor($pKfor){
	$lXml = $pKfor->lFieldArr['xml']['CurValue'];
	try{
		$pKfor->lFieldArr['xml']['CurValue'] = GetEolExportXmlTaxonExternalInfo($lXml);
	}catch(Exception $lException){
		$pKfor->SetError('get_taxon_external_info', $lException->getMessage());
	}
}

/**
	Добавя към xml-a на пенсофт xml-a от текущия експорт	
*/
function AppendEolExportToPensoftXmlFile($pKfor){
	$lExportId = $pKfor->lFieldArr['id']['CurValue'];
	try{
		$lFileNameSelectSql = '
			SELECT j.xml_file_name, e.xml, coalesce(e.appended_to_xml_file, 0) as appended_to_xml_file
			FROM eol_export e
			JOIN journals j ON j.id = e.journal_id
			WHERE e.id = ' . (int)$lExportId
		;
		$lUpdateExportSql = 'UPDATE eol_export SET 
			appended_to_xml_file = 1,
			time_appended_to_xml_file = CURRENT_TIMESTAMP
			WHERE id = ' . (int)$lExportId
		;
		
		$lCon = Con();
		$lCon->Execute($lFileNameSelectSql);
		$lCon->MoveFirst();
		
		$lFileName = $lCon->mRs['xml_file_name'];
		$lXml = $lCon->mRs['xml'];
		$lAppendedToXmlFile = (int)$lCon->mRs['appended_to_xml_file'];
		
		if( (int)$lAppendedToXmlFile ){
			throw new Exception(getstr('admin.eol_export.exportAlreadyAppended'));
		}
		if( !$lFileName ){
			throw new Exception(getstr('admin.eol_export.noFileNameForSelectedJournal'));
		}
		if( !trim($lXml )){
			throw new Exception(getstr('admin.eol_export.emptyXml'));
		}
		//Pravim temp fail v koito shte stoi xml-a
		$lTempFile = tempnam(sys_get_temp_dir(), 'eol_export');
		file_put_contents($lTempFile, $lXml);
		
		$lExternalQueryUrl = str_replace('{sourcefile}', rawurlencode($lTempFile), PENSOFT_EOL_EXPORT_APPEND_URL);
		$lExternalQueryUrl = str_replace('{targetfile}', rawurlencode($lFileName), $lExternalQueryUrl);
		
		$lResult = executeExternalQuery($lExternalQueryUrl);
		
		unlink($lTempFile);//Mahame temp file-a
		
		if( $lResult === PENSOFT_EOL_EXPORT_APPEND_SUCCESSFUL_REPLY ){//Ako vsi4ko e ok updatevame exporta za da ne mojem da go appendnem pak
			$lCon->Execute($lUpdateExportSql);
		}else{
			throw new Exception(getstr('admin.eol_export.appendCouldNotFinishSuccessfully') . $lResult);
		}
		
	}catch(Exception $lException){
		$pKfor->SetError('append_to_xml_file', $lException->getMessage());
	}
}

/**	
	Обикаля таксоните в xml-a и за всеки от тях се опитва да вземе външна информация от ubio
*/
//~ function GetEolExportXmlTaxonExternalInfo($pXml){
	//~ $pXml = $pKfor->lFieldArr['xml']['CurValue'];
	
	//~ /**
		//~ В този domDocument ще си държим xml-а от експорта
	//~ */
	//~ $lXmlDocument = new DOMDocument("1.0");
	//~ $lXmlDocument->resolveExternals = true;	
		
	//~ if( !$lXmlDocument->loadXML($pXml)){//Ako xml-a e greshen
		//~ throw new Exception(getstr('admin.eol_export.wrongXml'));
	//~ }
	
	//~ $lXPath = new DOMXPath($lXmlDocument);
	//~ $lTaxonQuery = '//taxon';
	//~ $lTaxonNodes = $lXPath->query($lTaxonQuery);
	
	//~ //Обикаляме всички таксони
	//~ for($i = 0; $i < $lTaxonNodes->length; ++$i){
		//~ $lCurrentTaxon = $lTaxonNodes->item($i);
		
	//~ }
	
	//~ return $lXmlDocument->saveXML();
//~ }

/**
	Vryshta link-a kym xml-a ili kym pdf-a na dadena statiq ot saita na pensoft. Id-to na statiqta e v identifier na taksona
*/
function getPensoftArticleLink($pJournalTitle, $pIssueId, $pIdentifier, $pReturnXmlLink = false){
	/**
		Pravim go statichno za da se vikne 1 pyt za celiq import
		Tuk se dyrjat linkovete kym statiite. Formata na dannite e sledniq
			pJournalTitle => masiv ot broeve v sledniq format
				nomer na broi => masiv ot statii sys sledniq format
					id na statiq => masiv ot linkove vyv sledniq format
						tip na linka => URL na linka
	*/
	static $lJournalArticlesInfo;
	if(!is_array($lJournalArticlesInfo))
		$lJournalArticlesInfo = array();
	if( !trim($pJournalTitle) || !(int)$pIssueId )
		return;
	if( !is_array($lJournalArticlesInfo[$pJournalTitle][$pIssueId]) || !count($lJournalArticlesInfo[$pJournalTitle][$pIssueId])){//Vzimame linkovete ot saita na pensoft		
		$lJournalArticlesInfo[$pJournalTitle][$pIssueId] = array();
		$lIssueExportUrl = PENSOFT_ISSUE_EXPORT_URL . '?title=' . rawurlencode($pJournalTitle) . '&volume=' . (int)$pIssueId;
		
		$lResult = executeExternalQuery($lIssueExportUrl);
		
		if( $lResult === false ){
			return;
		}
		$lTempXmlDocument = new DOMDocument("1.0");
		$lTempXmlDocument->resolveExternals = true;		
		
		if( !$lTempXmlDocument->loadXML($lResult)){//Ako xml-a e greshen
			return;
		}
		$lXPath = new DOMXPath($lTempXmlDocument);
		$lArticleXPathQuery = '/journal/articles/article';
		$lArticleXPathQueryResult = $lXPath->query($lArticleXPathQuery);	
		for($i = 0; $i < $lArticleXPathQueryResult->length; ++$i){
			$lCurrentArticle = $lArticleXPathQueryResult->item($i);
			$lCurrentArticleId = $lCurrentArticle->getAttribute('id');
			$lJournalArticlesInfo[$pJournalTitle][$pIssueId][$lCurrentArticleId] = array();
			$lLinksXPath = 'pdf_link|xml_link';//Tipovete linkove, koito shte pazim
			$lLinksXPathResult = $lXPath->query($lLinksXPath, $lCurrentArticle);
			for($j = 0; $j < $lLinksXPathResult->length; ++$j){
				$lCurrentLink = $lLinksXPathResult->item($j);
				$lCurrentLinkType = $lCurrentLink->nodeName;
				$lJournalArticlesInfo[$pJournalTitle][$pIssueId][$lCurrentArticleId][$lCurrentLinkType] = $lCurrentLink->nodeValue;
			}
		}		
	}
	if(!preg_match('/(.*)\.(\d)+\.(?P<article_id>\d+)\.sp\_(\d)+/i', $pIdentifier, $lMatchData))//Ako identifier-a e bygav
		return;
	$lArticleId = $lMatchData['article_id'];	
	if( $pReturnXmlLink ){
		$lLink = $lJournalArticlesInfo[$pJournalTitle][$pIssueId][$lArticleId]['xml_link'];
	}else{
		$lLink = $lJournalArticlesInfo[$pJournalTitle][$pIssueId][$lArticleId]['pdf_link'];
	}
	if( $lLink ){
		$lLink = '<a target="_blank" href="' . $lLink . '">click</a>';
	}
	return $lLink;
	
}
/*
	Връща id-то на статията с подадения doi
	10.3897/zookeys.84.774
	id-то са последните цифри след точката
*/
function getArticleIdFromDoi($pDoi){
	if( preg_match('/\.\s*(\d+)\s*$/', $pDoi, $lMatch)){
		return $lMatch[1];
	}
	return '';
}

/*
	Ако последният символ е точка - махаме го
*/
function parseMediaWikiSecTitle($pTitle){
	$pTitle = trim($pTitle);
	if( mb_substr($pTitle, -1) == '.')
		return mb_substr($pTitle, 0, mb_strlen($pTitle) - 1);
	return $pTitle;
}

/*
	Ако имаме нов ред с интервали след него - махаме ги
*/
function parseMediaWikiSecContent($pContent){
	$pContent = trim($pContent);
	$pContent = preg_replace('/ +/', ' ', $pContent);
	$pContent = preg_replace("/\n +/", "\n", $pContent);
	return $pContent;
}

function createIntFromString($pString){
	return preg_replace('/[A-Za-z]/', '', $pString);
	return (int)$pString;
}

/*
	Понеже в експорта за wikimedia трябва да изкарваме само по 1 път референциите
	а в xsl-а няма как да стане това - правим го тук.
	За всеки таксон инициализираме статичния масив наново на празен масив и в него отбелязваме кои цитати сме изкарали
*/
function checkForDuplicateRefId($pRefId, $pClearArray){
	static $lReferences = array();
	if( (int)$pClearArray ){
		$lReferences = array();
		return true;
	}
	if( !in_array($pRefId, $lReferences) ){
		$lReferences[] = $pRefId;
		return 1;
	}
	return 0;
}

/*
	Понеже в експорта за wikimedia трябва да изкарваме само по 1 път фигурите
	а в xsl-а няма как да стане това - правим го тук.
	За всеки таксон инициализираме статичния масив наново на празен масив и в него отбелязваме кои фигури сме изкарали
	Ако фигурата не е изкарвана вадим поредния и номер понеже ни трябва в xsl-a
*/
function checkForDuplicateFigId($pFigId, $pOper){
	static $lFigs = array();
	if( (int)$pOper == 1 ){//Zanulqvame masiva
		$lFigs = array();
		return true;
	}
	if( (int) $pOper == 2 )//Vryshtame informaciq za razmera na masiva
		return count($lFigs);
	
	//Ako prosto trqbva da gledame za nova stoinost
	if( !in_array($pFigId, $lFigs) ){
		$lFigs[] = $pFigId;
		return count($lFigs);
	}
	return 0;
}

/*
	Понеже в експорта за wikimedia трябва да изкарваме само първия път 
	page title като името на таксона, а в останалите случаи да добавяме и авторите, 
	а в xsl-а няма как да стане това - правим го тук.
	Ако досега не е имало такъв титле - връщаме 1 и отбелязваме титле-а. Иначе връщаме 0
*/
function checkForDuplicatePageTitle($pPageTitle){
	static $lPageTitles = array();
	if( !in_array($pPageTitle, $lPageTitles) ){
		$lPageTitles[] = $pPageTitle;
		return 1;
	}
	return 0;
}

/*
	Премахваме множеството спейсове и правим нов ред последван от спейсове само на нов ред
*/
function prepareXslText($pText){
	$pText = preg_replace('/ +/', ' ', $pText);
	$pText = preg_replace("/\n /", "\n", $pText);
	return $pText;
}
?>