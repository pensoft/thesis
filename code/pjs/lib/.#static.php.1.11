<?php


$docroot = getenv('DOCUMENT_ROOT');
require_once($docroot . '/lib/static-conf.php');
require_once($docroot . '/lib/conf.php');
require_once(PATH_ECMSFRCLASSES . 'static.php');
require_once(PATH_CLASSES . 'static.php');
require_once(PATH_CLASSES . SITE_NAME . '/templates/static.php');

$user = unserialize($_SESSION['suser']);

CleanCookiesFromRequest();
// crewrite instance
$rewrite =& new crewrite();

function CleanCookiesFromRequest() {
	foreach ($_COOKIE as $k => $v) {
		unset($_REQUEST[$k]);
	}
}

/* ### USER SECTION BEGIN ### */
$COOKIE_DOMAIN = $_SERVER['SERVER_NAME'];
$user = unserialize($_SESSION['suser']);

if (!$user->id && $_COOKIE['rememberme']) {
	$user = new clogin($_COOKIE['rememberme'], $_SERVER['REMOTE_ADDR']);
	$_SESSION['suser'] = serialize($user);
	if ($user->id) {
		header('Location: ' . $_SERVER['REQUEST_URI']);
		exit();
	}
}
// updateUsrLastAccess();

function updateUsrLastAccess() {
	global $user;

	if ((int)$user->id) {
		$lCon = Con();
		$lCon->Execute('UPDATE usr SET access_date = CURRENT_TIMESTAMP WHERE id = ' . (int)$user->id);
	}
}
/* ### USER SECTION END ### */

$gRubrMatch = array(
	// rubrid - menuid
	//2 => , // Новини
	7 => 3, // За OLSEN & PARTNERS
	9 => 12, // Другите за нас
	//13 => , // Слайдер
	//25 => , // Може да ви е интересно
	29 => 4, // Нашият екип
	45 => 5, // Услуги
	46 => 6, // Счетоводсто
		//47 => 7, // За юристи
		//48 => 8, // За Туристически компании
		//49 => 9, // За НПО
	50 => 10, // Данъци
	51 => 11, // Право
	52 => 13, // Нашите казуси
	54 => 15,
	53 => 15,
	// запивтване, контакти, за нас /титулна страница/
);

function modifyPageUrlStringParam($url, $par, $val) {
	if (preg_match('/[?&]' . $par . '=[^&]+/', $url)) {
		$res = preg_replace('/([?&])' . $par . '=[^&]+/', '${1}' . $par . '=' . $val, $url);
	}else {
		if (preg_match('/[?].*=\w+/', $url)) {
			$res = $url . '&' . $par . '=' . $val;
		}else{
			$res = $url . '?' . $par . '=' . $val;
		}
	}
	return $res;
}

function DefObjTempl() {
	global $user;
	global $rewrite;
	$t = array(
		'langswitcher'=>array('ctype'=>'clang', 'templs'=>array()),

		'mainmenu'=>array(
			'ctype'=>'crsrecursive',
			'templs'=>array(
				G_HEADER=>'menu.main-start',
				G_ROWTEMPL=>'menu.main-row',
				G_FOOTER =>'menu.main-end',
			),
			'recursivecolumn'=>'parentid',
			'templadd'=>'type',
			'sqlstr'=>'select id,'.getsqlang('name').','.getsqlang('href').','.getsqlang('img').',type,parentid from getMenuContents('.MAIN_MENU_ID.',0,'.CMS_SITEID.','.getlang().')',
			//'cache'=>'menu'
		),

		'footermenu'=>array(
			'ctype'=>'crs',
			'templs'=>array(
				G_HEADER=>'menu.footerstart',
				G_ROWTEMPL=>'menu.footerrow',
				G_FOOTER =>'menu.footerend',
			),
			'recursivecolumn'=>'parentid',
			'templadd'=>'type',
			'sqlstr'=>'select id,'.getsqlang('name').','.getsqlang('href').','.getsqlang('img').',type,parentid from getMenuContents('.MAIN_MENU_ID.',0,'.CMS_SITEID.','.getlang().') where parentid ='.MAIN_MENU_ID,
			//'cache'=>'menu'
		),

		'metadata'=>array(
			'ctype'=>'cmetadata',
			'templs'=>array(
				G_DEFAULT=>'global.metadata',
			),
		),

		'breadcrumbs' => getCpath(),

		'interesting' => array(
			'ctype' => 'crs',
			'templs' => array(
				G_HEADER => 'home.dottedRubrListStart',
				G_ROWTEMPL => 'home.dottedRubrListRow',
				G_FOOTER => 'home.dottedRubrListEnd',
			),
			//'_rewrite_' => $rewrite,

			//~ рубрика

				//~ 'sqlstr' => 'SELECT DISTINCT ON ( s.guid ) s.guid, s.title, ' . getsqlang('r.name') . ' as mainrubrname, r.id as rubrid
					//~ FROM stories s
					//~ JOIN sites si ON (si.guid = s.primarysite)
					//~ JOIN storyproperties sp ON s.guid = sp.guid
					//~ JOIN rubr r on r.id = sp.valint AND ( sp.propid = 4 OR sp.propid = 1 )
					//~ WHERE s.pubdate < now() AND s.state IN (3,4) AND r.rootnode = '. INTERESTIGN_RUBRID . ' AND s.lang=\''.getlang(true).'\'
					//~ ORDER BY s.guid, s.pubdate DESC',

			//~ нареден списък
			'sqlstr'=>'SELECT s.guid, s.title, s.description, s.previewpicid, ' . getsqlang('r.name') . ' as mainrubrname, r.id as rubrid
			FROM stories s
			JOIN storyproperties sp ON s.guid = sp.guid
			JOIN rubr r on r.id = sp.valint AND sp.propid = 4
			JOIN listdets d ON d.objid = s.guid
			JOIN listnames l ON l.listnameid = d.listnameid
			WHERE s.state IN (3, 4) AND l.listnameid = ' . LIST_INTERESTING_ID . ' AND s.lang=\''.getlang(true).'\'
			ORDER BY d.posid, s.pubdate DESC
		',
	)


		/*'loginform' => array(
			'ctype' => 'csimple',
			'err' => GetLoginErr(),
			'fullname' => $user->fullname,
			'templs' => array(
				G_DEFAULT => ($user->id ? 'loginform.logged' : 'loginform.unlogged'),
			),
		),*/
	);

	return $t;
}

function showPicIfExists($pid, $pref, $class = false) {
	if ($pid) {
		return '<img src="' . SHOWIMG_URL .
		$pref . '_' . $pid . '.jpg" border="0" alt="" ' .
		($class ? 'class="' . $class . '"' : '') . '/>';
	}
	return '';
}

function showSlidePicIfExists($pid, $pref, $preflref, $class = false) {
	$lImgPath = PATH_DL . $pref . '_' . $pid . '.jpg';
	if ($pid) {
		// показване на големия имидж
		$lCont = '<img src="' . SHOWIMG_URL .
					$pref . '_' . $pid . '.jpg" border="0" alt="" ' .
					($class ? 'class="' . $class . '"' : '') . '/>';
		// ако е създаден успешно правим огледално изображение
		if (is_file($lImgPath))
			//~ $lCont .= '<img class="reflection" style=""
					//~ src="' . SHOWIMG_URL .
					//~ $preflref . '_' . $pid . '.jpg" border="0" alt="" ' .
					//~ ($class ? 'class="' . $class . '"' : '') . '/>';

		return $lCont;
	}
	return '';
}

function showPicIfExistsInFrame($pid, $pref, $class = false) {
	if ($pid) {
		return '<div class="' . $class . '"><img src="' . SHOWIMG_URL .
		$pref . '_' . $pid . '.jpg" border="0" alt="" ' .
		($class ? 'class=""' : '') . '/></div>';
	}
	return '';
}

function showItemIfExists ($item, $leftCont, $rightCont, $nl2br = false) {
	return ($item ? $leftCont . ($nl2br ? nl2br($item) : $item) . $rightCont : '');
}

function CutText($d, $len = 80) {
	$d = strip_tags($d);
	if (mb_strlen($d, 'UTF-8') < $len) return $d;
	$cut = mb_substr($d, 0, $len, 'UTF-8');
	return mb_substr($cut, 0, mb_strrpos($cut, ' ', 'UTF-8'), 'UTF-8') . '...';
}

function GetLoginErr() {
	global $user;
	if (!isset($user->errcode)) return '';
	if ((int)$user->errcode == 3) return '';
	$ea = array(
		0 => getstr('loginform.nosuchuser'),
		1 => getstr('loginform.noactiveuser'),
		2 => getstr('loginform.ipdenied'),
	);
	unset($_SESSION['suser']);
	return $ea[(int)$user->errcode];
}

function showCaptchaIfExists($pRs){
	//~ var_dump($pRs);
	if( (int) $pRs['hascaptcha'] )
		return '
			<div class="label">
				' . getstr('global.captchalabel') . '
			</div>
			<div class="captcha">
				<img src="/lib/frmcaptcha.php" id="cappic" border="0" alt="" class="captchaimage" /> &raquo;
				<input type="text" class="captchacode" name="captcha"></input>
				<div class="unfloat"></div>
			</div>
	';
}

function showPlayerByType($pFtype, $pId, $pHtml = false) {
	$lFtype = (int)$pFtype;
	$lId = (int)$pId;

	if ($lFtype && $lId) {
		switch ($lFtype) {
			case 3: // Audio
				return '
					<object style="vertical-align: middle;" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0" width="150" height="20">
						<param name="movie" value="/singlemp3player.swf?file=/getatt.php?filename=o_' . $lId . '.mp3&songVolume=80&showDownload=false" />
						<param name="quality" value="high">
						<param name="wmode" value="transparent" />
						<embed
							style="vertical-align: middle;"
							width="150"
							height="20"
							src="/singlemp3player.swf?file=/getatt.php?filename=o_' . $lId . '.mp3&songVolume=80&showDownload=false"
							quality="high"
							wmode="transparent"
							type="application/x-shockwave-flash"
							pluginspage="http://www.macromedia.com/go/getflashplayer"
						/>
					</object>
				';
				break;
			case 4: // Video
				return '
					<embed
						width="435"
						height="326"
						src="/mediaplayer.swf"
						quality="high"
						wmode="transparent"
						flashvars="width=435&amp;height=326&amp;autostart=false&amp;file=/getatt.php?filename=oo_' . $lId . '.flv&amp;type=flv&amp;repeat=false&amp;image=/showimg.php?filename=big_' . $lId . '.jpg&amp;showdownload=false&amp;link=/getatt.php?filename=oo_' . $lId . '.flv&amp;allowfullscreen=true&amp;showdigits=true&amp;shownavigation=true&amp;logo=&amp;largecontrols=false&amp;backcolor=0xffffff&amp;frontcolor=0x000000&amp;lightcolor=0x000000&amp;screencolor=0x000000"
						menu="false"
						allowfullscreen="true"
						loop="false"
						play="false"
						type="application/x-shockwave-flash"
						pluginspage="http://www.macromedia.com/go/getflashplayer"
					/>
				';
				break;
			case 5: // Embed video
				return $pHtml;
				break;
			default:
				break;

		}
	}
}


function formatDate( $pPubDate ){
	// Понеделник, 25 Юли 2011 16:17
	//29/07/2011 16:19:00

	global $gMonths;
	global $gDaysOfWeek;



	$lDatePattern = "#(\d+)/(\d+)/(\d+) (\d+):(\d+):(\d+)#isu";
	$lMatches;
	$l = preg_match( $lDatePattern, $pPubDate, $lMatches );

	// това няма откъде да го взема, така че викам дате
	$lWeekDay = $gDaysOfWeek[ (int)date(  'N' , strtotime( $lMatches[3] . '-' . $lMatches[2] . '-' . $lMatches[1] ) ) ];
	//var_dump((int)date(  'N' , strtotime( $lMatches[3] . '-' . $lMatches[2] . '-' . $lMatches[1] ) ) .  $lWeekDay );

	$lDate = $lWeekDay . ', ' . $lMatches[1] . ' ' . $gMonths[(int)$lMatches[2]] . ' ' . $lMatches[3] . ' ' . $lMatches[4]. ':' . $lMatches[5] ;

	return $lDate;
}

function formatDateSimple ( $pPubDate , $pStoryId = false ){
	// Понеделник, 25 Юли 2011 16:17
	//29/07/2011 16:19:00

	global $gMonths;
	global $gDaysOfWeek;
	global $gContactsStoryIds;

	$lDatePattern = "#(\d+)/(\d+)/(\d+) (\d+):(\d+):(\d+)#isu";
	$lMatches;
	$l = preg_match( $lDatePattern, $pPubDate, $lMatches );

	// това няма откъде да го взема, така че викам дате
	$lWeekDay = $gDaysOfWeek[ (int)date(  'N' , strtotime( $lMatches[3] . '-' . $lMatches[2] . '-' . $lMatches[1] ) ) ];

	//$lDate = $lWeekDay . ', ' . $lMatches[1] . ' ' . $gMonths[(int)$lMatches[2]] . ' ' . $lMatches[3] . ' ' . $lMatches[4]. ':' . $lMatches[5] ;
	$lDate = $lMatches[1] . ' ' . $gMonths[(int)$lMatches[2]] . ' ' . $lMatches[3];

	if( in_array($pStoryId, $gContactsStoryIds ) ) {
		return '';
	} else {
		return $lDate;
	}

}

function getOnlyDatePart($pDate){
	$lDateArr = explode(' ', $pDate);
	return $lDateArr[0];
}

function GetMainRubrid($pRubrid){
		$lCon = Con();
		//$lSql = 'SELECT rubrid FROM spGetMainRubrid(' . (int) $pRubrid . ')';
		$lSql = 'SELECT rootnode as rubrid FROM rubr WHERE id = ' . (int) $pRubrid;
		$lCon->Execute($lSql);
		$lCon->MoveFirst();
		$lRootNode = (int) $lCon->mRs['rubrid'];
		return $lRootNode;
}

function getCpath(){
	global $gRubrid;
	global $gStoryTitle;
	global $gStoryid;

	$lCpath = array(
				'ctype' => 'cpathtxt',
				'rubrid' => $gRubrid,
				'templs' => array(
					G_HEADER => 'pathtxt.header',
					G_FOOTER => 'pathtxt.footer',
					G_STARTRS => 'global.empty',
					G_ENDRS => 'global.empty',
					G_ROWTEMPL => 'pathtxt.rowtempl',
					G_NODATA => 'global.empty',
					G_PAGEING => 'global.empty'
				),
				'flag' => 0,
				//'_rewrite_' => $rewrite,
				'pathlink' => '/browse.php?rubrid=',
				//'storytitle' => $lContent->GetVal('name'),
				'storyid' => $gStoryid,
				'storytitle' => $gStoryTitle,
		);

	return $lCpath;
}

function isActiveTab( $pMenuId ){
	global $gMainRubrid;
	global $gRubrMatch;

	if( $pMenuId == HOME_MENU_ID ) return 'selected';
	if( $gRubrMatch[$gMainRubrid] == $pMenuId) return 'selected';

}

function checkEmailAddr($pFld) {
	if(!preg_match("/^[A-Za-z0-9_\.-]+@([A-Za-z0-9_\.-])+\.[A-Za-z]{2,6}$/",  $pFld ))
		return 'Not a valid email';
}

function getBaseRegError($pErrCnt){
	if((int)$pErrCnt){
		return getstr('pjs.registerBaseErrMsg');
	}
}

function prepAutocompleteKforField($pKforFieldVals) {
	$pos = strpos($pKforFieldVals, '{');
	if($pos === false) {
		return '(' . $pKforFieldVals . ')';
	}else {
		$lReplChars = str_replace('{', '(', $pKforFieldVals);
		return str_replace('}', ')', $lReplChars);
	}
}

function MyStripTags($pText) {
	if ($pText) {
		return '\'' . q(strip_tags($pText)) . '\'';
	}
}

/**
 * Приготвяме стойността за слагане в xml.
 * Тук трябва да конвертиране всички ентитита в символи с изключение на amp; lt; gt; quot; apos; (съответно и цифровите им стойности)
 * Правим html_entity_decode за да може ако има entity-та (напр &micro;) да станата символи
 *
 * @param unknown_type $pValue
 * @return unknown
 */
function prepareXmlValue($pValue){
	// 	$pValue = preg_replace('/([\<\>\'\"])/', '\$\$\$\$${1}####', $pValue);
	// 	$pValue = html_entity_decode($pValue, ENT_QUOTES, "UTF-8");
	// 	$pValue = htmlspecialchars($pValue, ENT_QUOTES);

	// 	$pValue = preg_replace_callback('/\$\$\$\$(.*)####/imsU',
	// 			function($pMatches){return htmlspecialchars_decode($pMatches[1], ENT_QUOTES);},
	// 		$pValue);


	$pValue = preg_replace_callback('/\&(?!amp|#0*38|lt|#0*60|gt|#0*62|quot|#0*34|apos|#0*39;)(.*);/imsU',
	ArrHTMLEntityDecode,
	$pValue);


	return $pValue;
}

function ArrHTMLEntityDecode($pMatches){
	return html_entity_decode($pMatches[0], ENT_NOQUOTES, "UTF-8");
}


function DeletePicFiles($pPicId){
	if( !$pPicId )
		return;
	$lFormats = array('gif', 'jpg', 'png');
	foreach($lFormats as $lFormat){
		$lPrefixes = array('oo', 'big', 'gb', 's', 'mx50', 'm80', 'd200x150');
		foreach( $lPrefixes as $lPrefix){
			$lFile = PATH_DL . $lPrefix . '_' . $pPicId . '.' . $lFormat;
			if( file_exists($lFile) )
				unlink($lFile);
		}
	}
}
?>